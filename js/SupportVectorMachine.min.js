angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("SupportVectorMachineController",["$scope","Webworker","FileSaver","Blob",function(e,a,n,t){class r{constructor(e,a,n,t,r,l,i){this.index=e,this.Type=a,this.KernelParam=n,this.C=t,this.MaxIterations=r,this.Tolerance=l,this.Category=i}}e.Models=[],e.Normalization=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.Training=!1,e.TrainingProgress=0,e.Threshold=.9,e.ClassifierProgress=0,e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.TestData=[],e.Samples=0,e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.KernelType={Polynomial:0,Gaussian:1,Radial:2,Sigmoid:3,Linear:4,Fourier:5},e.KernelNames=["Polynomial","Gaussian","Radial","Sigmoid","Linear","Fourier"],e.kernel=e.KernelNames[0],e.SelectedKernel=0,e.bias=0,e.exponent=2,e.sigma=.01,e.slope=1,e.intercept=0,e.scalingFactor=1,e.category=0,e.regularization=1,e.passes=5,e.tolerance=1e-5,e.SelectedModel=0,e.PlotWidth=1024,e.PlotHeight=1024,e.SelectDelimiter=function(){var a=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=a+1},e.SelectKernel=function(){var a=e.KernelNames.indexOf(e.kernel);e.SelectedKernel=a},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var a=new FileReader;a.onload=function(n){e.$apply(function(){for(var n=a.result.split("\n"),t=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<n.length;r++){var l=[],i=n[r].trim().split(t);if(i.length>0){if(0==r&&i.length>1&&(e.Inputs=i.length-1),i.length>1){var o=parseInt(i[i.length-1]);e.Categories=Math.max(e.Categories,o),e.Output.push([o])}for(var s=0;s<i.length-1;s++)l.push(parseFloat(i[s]));l.length>0&&(e.TrainingData.push(l),e.Items++)}}e.fileContent=a.result.trim()})},null!=e.SelectedFile.name&&a.readAsText(e.SelectedFile)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var a=new FileReader;a.onload=function(n){e.$apply(function(){for(var n=a.result.split("\n"),t=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<n.length;r++){var l=[],i=n[r].trim().split(t);if(i.length>=e.Inputs){for(var o=0;o<i.length;o++)o>=0&&o<e.Inputs&&l.push(parseFloat(i[o]));l.length>0&&(e.TestData.push(l),e.Samples++)}}e.testContent=a.result.trim()})},null!=e.TestFile.name&&a.readAsText(e.TestFile)},e.RenumberModels=function(){for(var a=0;a<e.Models.length;a++)e.Models[a].index=a+1},e.AddModel=function(){if(0!=e.category&&e.Models.findIndex(a=>a.Category==e.category)<0){var a=void 0;if(e.SelectedKernel==e.KernelType.Polynomial)a=new r(e.Models.length+1,e.KernelType.Polynomial,[e.bias,e.exponent],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial)a=new r(e.Models.length+1,e.SelectedKernel==e.KernelType.Gaussian?e.KernelType.Gaussian:e.KernelType.Radial,[e.sigma],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear)a=new r(e.Models.length+1,e.SelectedKernel==e.KernelType.Sigmoid?e.KernelType.Sigmoid:e.KernelType.Linear,[e.slope,e.intercept],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Fourier)a=new r(e.Models.length+1,e.KernelType.Fourier,[e.scalingFactor],e.regularization,e.passes,e.tolerance,e.category);null!=a&&e.Models.push(a)}},e.SelectModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var a=e.Models[e.SelectedModel-1];e.kernel=e.KernelNames[a.Type],e.SelectedKernel=a.Type,a.Type==e.KernelType.Polynomial?(e.bias=a.KernelParam[0],e.exponent=a.KernelParam[1]):a.Type==e.KernelType.Gaussian||a.Type==e.KernelType.Radial?e.sigma=a.KernelParam[0]:a.Type==e.KernelType.Sigmoid||a.Type==e.KernelType.Linear?(e.slope=a.KernelParam[0],e.intercept=a.KernelParam[1]):a.Type==e.KernelType.Fourier&&(e.scalingFactor=a.KernelParam[0]),e.passes=a.MaxIterations,e.regularization=a.C,e.tolerance=a.Tolerance,e.category=a.Category}},e.RemoveModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var a=0;a<e.Models.length;a++)if(e.Models[a].index==e.SelectedModel){e.Models.splice(a,1);break}e.RenumberModels(),e.SelectedModel=0}},e.UpdateModel=function(){var a=e.SelectedModel-1;a>=0&&a<e.Models.length&&(e.Models[a].Type=e.SelectedKernel,e.SelectedKernel==e.KernelType.Polynomial?e.Models[a].KernelParam=[e.bias,e.exponent]:e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?e.Models[a].KernelParam=[e.sigma]:e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?e.Models[a].KernelParam=[e.slope,e.intercept]:e.SelectedKernel==e.KernelType.Fourier&&(e.Models[a].KernelParam=[e.scalingFactor]),e.Models[a].MaxIterations=e.passes,e.Models[a].C=e.regularization,e.Models[a].Tolerance=e.tolerance,e.Models[a].Category=e.category)},e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(a){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(a){e.asyncClassifier=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Models.length>0&&e.TrainingData.length>0&&e.Output.length>0){var n=document.URL;e.Training=!0,e.asyncTrainer=a.create(function(e,a,n,t){importScripts(e+"js/Models.js");for(var r=[],l=(new SupportVectorMachine,Matrix.Normalize(a)),i=[l.min,l.max],o=0;o<t.length;o++){var s=t[o],c=new SupportVectorMachine;c.Setup(a,n,s.C,s.Type,s.KernelParam,s.Tolerance,s.MaxIterations,s.Category),r.push(c)}for(var d=!(r.length>0);!d;){d=!0;var g=0,p=0;for(o=0;o<r.length;o++){var u=r[o].Step();g+=r[o].MaxIterations,p+=r[o].Iterations,u&&!r[o].Trained&&r[o].Generate(),d&=u}notify({Iterations:p,MaxIterations:g})}for(o=0;o<r.length;o++)r[o].index=o+1;complete({models:r,normalization:i})},{async:!0}),e.asyncTrainer.run(n,e.TrainingData,e.Output,e.Models).then(function(a){e.Models=a.models,e.Normalization=a.normalization,e.TrainingProgress=1,e.Training=!1,e.SelectedModel=0},null,function(a){e.TrainingProgress=a.Iterations/a.MaxIterations}).catch(function(a){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Models&&e.Normalization.length>1){var n=document.URL;e.asyncClassifier=a.create(function(e,a,n,t,r,l){importScripts(e+"js/Models.min.js");var i=Matrix.Create(a.length,1);Matrix.Set(i,0);var o=Matrix.Create(a.length,1);if(Matrix.Set(o,0),0!=r){var s=r-1;t[s].Trained&&((d=new SupportVectorMachine).Initialize(t[s].ModelX,t[s].ModelY,t[s].Type,t[s].KernelParam,t[s].Alpha,t[s].B,t[s].W,t[s].MaxIterations,t[s].C,t[s].Category),i=d.Classify(a,l),o=d.Predict(a,l))}else for(var c=0;c<t.length;c++)if(t[c].Trained){var d;(d=new SupportVectorMachine).Initialize(t[c].ModelX,t[c].ModelY,t[c].Type,t[c].KernelParam,t[c].Alpha,t[c].B,t[c].W,t[c].MaxIterations,t[c].C,t[c].Category);for(var g=d.Predict(a),p=0;p<g.length;p++)g[p][0]>o[p][0]&&(o[p][0]=g[p][0],i[p][0]=g[p][0]>=l?t[c].Category:0)}complete({classification:i,prediction:o})},{async:!0}),e.asyncClassifier.run(n,e.TestData,e.Normalization,e.Models,e.SelectedModel,e.Threshold).then(function(a){if(e.classificationResult="",null!=a.classification){e.Classification=a.classification;for(var n=0;n<e.Classification.length;n++)n>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[n][0].toString()}null!=a.prediction&&(e.Prediction=a.prediction),e.ClassifierProgress=1},null,function(e){}).catch(function(a){e.asyncClassifier=null})}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.DisplayModelParameters=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var a=e.Models[e.SelectedModel-1];if(a.Trained){for(var n=[],t=0;t<a.W.length;t++)n.push(a.W[t][0]);var r={ModelX:a.ModelX,ModelY:a.ModelY,Type:a.Type,KernelParam:a.KernelParam,W:n,B:a.B,C:a.C,Tolerance:a.Tolerance,Category:a.Category,Passes:a.Iterations,Iterations:a.Iterations,MaxIterations:a.MaxIterations,Trained:a.Trained};e.modelParameters=e.PrettyPrint(r)}}},e.SaveModels=function(){if(null!=e.Models&&e.Normalization.length>1){for(var a=[],r=0;r<e.Models.length;r++){var l=e.Models[r];if(l.Trained){for(var i=[],o=0;o<l.W.length;o++)i.push(l.W[o][0]);var s={ModelX:l.ModelX,ModelY:l.ModelY,Type:l.Type,KernelParam:l.KernelParam,Alpha:l.Alpha,W:i,B:l.B,C:l.C,Tolerance:l.Tolerance,Category:l.Category,Passes:l.Iterations,Iterations:l.Iterations,MaxIterations:l.MaxIterations,Trained:l.Trained};a.push(s)}}var c={Models:a,Normalization:e.Normalization},d=JSON.stringify(c),g=new t([d],{type:"application/json"});n.saveAs(g,"Models.json")}},e.LoadSVM=function(){e.Models=[],e.Inputs=0,e.Categories=0,e.SelectedModel=0;var a=new FileReader;a.onload=function(n){e.$apply(function(){var n=JSON.parse(a.result);if(null!=n.Models&&null!=n.Normalization){e.Normalization=n.Normalization,e.Inputs=n.Models[0].ModelX[0].length;for(var t=0;t<n.Models.length;t++){var r=n.Models[t],l=[];e.Categories=Math.max(e.Categories,r.Category);for(var i=0;i<r.W.length;i++)l.push([r.W[i]]);var o={index:t+1,ModelX:r.ModelX,ModelY:r.ModelY,Type:r.Type,KernelParam:r.KernelParam,Alpha:r.Alpha,W:l,B:r.B,C:r.C,Tolerance:r.Tolerance,Category:r.Category,Passes:r.Iterations,Iterations:r.Iterations,MaxIterations:r.MaxIterations,Trained:r.Trained};e.Models.push(o)}}})},null!=e.NetworkFile.name&&a.readAsText(e.NetworkFile)},e.RenderTestData=function(){if(e.TestData.length>0&&e.Classification.length>0&&e.Classification.length==e.TestData.length&&null!=e.Normalization){var a=e.PlotWidth,n=e.PlotHeight,t=d3.scaleOrdinal(d3.schemeCategory10),r=d3.select("#plot").attr("width",a).attr("height",n);r.selectAll("*").remove();var l=d3.scaleLinear().domain([0,1]).range([.1*a,.8*a]),o=d3.scaleLinear().domain([0,1]).range([.8*n,.1*n]),s=(t=d3.scaleOrdinal(d3.schemeCategory10),r.append("g").classed("points_g",!0));data=function(e,a,n,t){var r=[],l=e.length;for(i=0;i<l;i++){var o={};o.x=(e[i][0]-n[0])/(t[0]-n[0]),o.y=(e[i][1]-n[1])/(t[1]-n[1]),o.color=a[i],r.push(o)}return r}(e.TestData,e.Classification,e.Normalization[0],e.Normalization[1]);var c=s.selectAll("circle").data(data);c=c.enter().append("circle").attr("cx",function(e){return l(e.x)}).attr("cy",function(e){return o(e.y)}).attr("r",5).style("fill",function(e){return t(e.color)})}},e.SaveRenderedData=function(){var a=$("#plot")[0].innerHTML;if(null!=a){(a="<svg>"+a+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(a=a.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),a.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(a=a.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.PlotWidth.toString()+'px" height="'+e.PlotHeight.toString()+'px"'));var r=new t([a],{type:"image/svg+xml;charset=utf-8"});n.saveAs(r,"Classification.svg")}}}]).directive("inputBind",function(){return function(e,a,n){a.bind("change",function(a){e.$apply(function(e){e[n.name]=a.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=a.target.files[0]})})}}).directive("testBind",function(){return function(e,a,n){a.bind("change",function(a){e.$apply(function(e){e[n.name]=a.target.files,e.Samples=0,e.TestFile=a.target.files[0]})})}}).directive("networkBind",function(){return function(e,a,n){a.bind("change",function(a){e.$apply(function(e){e[n.name]=a.target.files,e.NetworkFile=a.target.files[0]})})}});