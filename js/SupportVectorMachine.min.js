angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("SupportVectorMachineController",["$scope","Webworker","FileSaver","Blob",function(e,t,r,a){class n{constructor(e,t,r,a,n,l,i){this.index=e,this.Type=t,this.KernelParam=r,this.C=a,this.MaxIterations=n,this.Tolerance=l,this.Category=i}}e.Models=[],e.Normalization=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.Training=!1,e.TrainingProgress=0,e.Threshold=.9,e.ClassifierProgress=0,e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.asyncPlotter=void 0,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.TestData=[],e.Samples=0,e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.KernelType={Polynomial:0,Gaussian:1,Radial:2,Sigmoid:3,Linear:4,Fourier:5},e.KernelNames=["Polynomial","Gaussian","Radial","Sigmoid","Linear","Fourier"],e.kernel=e.KernelNames[0],e.SelectedKernel=0,e.bias=0,e.exponent=2,e.sigma=.01,e.slope=1,e.intercept=0,e.scalingFactor=1,e.category=0,e.regularization=1,e.passes=5,e.tolerance=1e-5,e.SelectedModel=0,e.PlotWidth=1024,e.PlotHeight=1024,e.plotContours=!1,e.SelectDelimiter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.SelectKernel=function(){var t=e.KernelNames.indexOf(e.kernel);e.SelectedKernel=t},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>0){if(0==n&&i.length>1&&(e.Inputs=i.length-1),i.length>1){var o=parseInt(i[i.length-1]);e.Categories=Math.max(e.Categories,o),e.Output.push([o])}for(var s=0;s<i.length-1;s++)l.push(parseFloat(i[s]));l.length>0&&(e.TrainingData.push(l),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>=e.Inputs){for(var o=0;o<i.length;o++)o>=0&&o<e.Inputs&&l.push(parseFloat(i[o]));l.length>0&&(e.TestData.push(l),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.RenumberModels=function(){for(var t=0;t<e.Models.length;t++)e.Models[t].index=t+1},e.AddModel=function(){if(0!=e.category&&e.Models.findIndex(t=>t.Category==e.category)<0){var t=void 0;e.SelectedKernel==e.KernelType.Polynomial?t=new n(e.Models.length+1,e.KernelType.Polynomial,[e.bias,e.exponent],e.regularization,e.passes,e.tolerance,e.category):e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Gaussian?e.KernelType.Gaussian:e.KernelType.Radial,[e.sigma],e.regularization,e.passes,e.tolerance,e.category):e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Sigmoid?e.KernelType.Sigmoid:e.KernelType.Linear,[e.slope,e.intercept],e.regularization,e.passes,e.tolerance,e.category):e.SelectedKernel==e.KernelType.Fourier&&(t=new n(e.Models.length+1,e.KernelType.Fourier,[e.scalingFactor],e.regularization,e.passes,e.tolerance,e.category)),null!=t&&e.Models.push(t)}},e.SelectModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];e.kernel=e.KernelNames[t.Type],e.SelectedKernel=t.Type,t.Type==e.KernelType.Polynomial?(e.bias=t.KernelParam[0],e.exponent=t.KernelParam[1]):t.Type==e.KernelType.Gaussian||t.Type==e.KernelType.Radial?e.sigma=t.KernelParam[0]:t.Type==e.KernelType.Sigmoid||t.Type==e.KernelType.Linear?(e.slope=t.KernelParam[0],e.intercept=t.KernelParam[1]):t.Type==e.KernelType.Fourier&&(e.scalingFactor=t.KernelParam[0]),e.passes=t.MaxIterations,e.regularization=t.C,e.tolerance=t.Tolerance,e.category=t.Category}},e.RemoveModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var t=0;t<e.Models.length;t++)if(e.Models[t].index==e.SelectedModel){e.Models.splice(t,1);break}e.RenumberModels(),e.SelectedModel=0}},e.UpdateModel=function(){var t=e.SelectedModel-1;t>=0&&t<e.Models.length&&(e.Models[t].Type=e.SelectedKernel,e.SelectedKernel==e.KernelType.Polynomial?e.Models[t].KernelParam=[e.bias,e.exponent]:e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?e.Models[t].KernelParam=[e.sigma]:e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?e.Models[t].KernelParam=[e.slope,e.intercept]:e.SelectedKernel==e.KernelType.Fourier&&(e.Models[t].KernelParam=[e.scalingFactor]),e.Models[t].MaxIterations=e.passes,e.Models[t].C=e.regularization,e.Models[t].Tolerance=e.tolerance,e.Models[t].Category=e.category)},e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncClassifier=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Models.length>0&&e.TrainingData.length>0&&e.Output.length>0){var r=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,r,a){importScripts(e+"js/Models.js");var n,l=[],i=Matrix.Normalize(t),o=[i.min,i.max];for(n=0;n<a.length;n++){var s=a[n],c=new SupportVectorMachine;c.Setup(t,r,s.C,s.Type,s.KernelParam,s.Tolerance,s.MaxIterations,s.Category),l.push(c)}for(var d=!(l.length>0);!d;){d=!0;var g=0,p=0;for(n=0;n<l.length;n++){var u=l[n].Step();g+=l[n].MaxIterations,p+=l[n].Iterations,u&&l[n].Generate(),d&=u}notify({Iterations:p,MaxIterations:g})}for(n=0;n<l.length;n++)l[n].index=n+1;complete({models:l,normalization:o})},{async:!0}),e.asyncTrainer.run(r,e.TrainingData,e.Output,e.Models).then(function(t){e.Models=t.models,e.Normalization=t.normalization,e.TrainingProgress=1,e.Training=!1,e.SelectedModel=0},null,function(t){e.TrainingProgress=t.Iterations/t.MaxIterations}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Models){e.ClassifierProgress=0;var r=document.URL;e.asyncClassifier=t.create(function(e,t,r,a,n){importScripts(e+"js/Models.js");var l=Matrix.Create(t.length,1);Matrix.Set(l,0);var i,o,s,c,d,g=Matrix.Create(t.length,1);if(Matrix.Set(g,0),0!=a){var p=a-1;if(r[p].Trained)for((i=new SupportVectorMachine).Initialize(r[p].ModelX,r[p].ModelY,r[p].Type,r[p].KernelParam,r[p].Alpha,r[p].B,r[p].W,r[p].MaxIterations,r[p].C,r[p].Category),o=0;o<t.length;o+=100){for(c=i.Predict(t.slice(o,o+100)),s=0;s<c.length;s++)c[s][0]>g[o+s][0]&&(g[o+s][0]=c[s][0],l[o+s][0]=c[s][0]>=n?i.Category:0);d=o/t.length,notify({ClassifierProgress:d})}}else for(var u=0;u<r.length;u++)if(r[u].Trained)for((i=new SupportVectorMachine).Initialize(r[u].ModelX,r[u].ModelY,r[u].Type,r[u].KernelParam,r[u].Alpha,r[u].B,r[u].W,r[u].MaxIterations,r[u].C,r[u].Category),o=0;o<t.length;o+=100){for(c=i.Predict(t.slice(o,o+100)),s=0;s<c.length;s++)c[s][0]>g[o+s][0]&&(g[o+s][0]=c[s][0],l[o+s][0]=c[s][0]>=n?r[u].Category:0);d=(u*t.length+o)/(r.length*t.length),notify({ClassifierProgress:d})}complete({classification:l,prediction:g})},{async:!0}),e.asyncClassifier.run(r,e.TestData,e.Models,e.SelectedModel,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var r=0;r<e.Classification.length;r++)r>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[r][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1,d3.select("#plot").selectAll("*").remove()},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncClassifier=null})}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.DisplayModelParameters=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var t=e.Models[e.SelectedModel-1],r=[],a=0;a<t.W.length;a++)r.push(t.W[a][0]);var n={ModelX:t.ModelX,ModelY:t.ModelY,Type:t.Type,KernelParam:t.KernelParam,W:r,B:t.B,C:t.C,Tolerance:t.Tolerance,Category:t.Category,Passes:t.Iterations,Iterations:t.Iterations,MaxIterations:t.MaxIterations,Trained:t.Trained};e.modelParameters=e.PrettyPrint(n)}},e.SaveModels=function(){if(null!=e.Models&&e.Normalization.length>1){for(var t=[],n=0;n<e.Models.length;n++){var l=e.Models[n];if(l.Trained){for(var i=[],o=0;o<l.W.length;o++)i.push(l.W[o][0]);var s={ModelX:l.ModelX,ModelY:l.ModelY,Type:l.Type,KernelParam:l.KernelParam,Alpha:l.Alpha,W:i,B:l.B,C:l.C,Tolerance:l.Tolerance,Category:l.Category,Passes:l.Iterations,Iterations:l.Iterations,MaxIterations:l.MaxIterations,Trained:l.Trained};t.push(s)}}var c={Models:t,Normalization:e.Normalization},d=JSON.stringify(c),g=new a([d],{type:"application/json"});r.saveAs(g,"Models.json")}},e.LoadSVM=function(){e.Models=[],e.Inputs=0,e.Categories=0,e.SelectedModel=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){var r=JSON.parse(t.result);if(null!=r.Models&&null!=r.Normalization){e.Normalization=r.Normalization,e.Inputs=r.Models[0].ModelX[0].length;for(var a=0;a<r.Models.length;a++){var n=r.Models[a],l=[];e.Categories=Math.max(e.Categories,n.Category);for(var i=0;i<n.W.length;i++)l.push([n.W[i]]);var o={index:a+1,ModelX:n.ModelX,ModelY:n.ModelY,Type:n.Type,KernelParam:n.KernelParam,Alpha:n.Alpha,W:l,B:n.B,C:n.C,Tolerance:n.Tolerance,Category:n.Category,Passes:n.Iterations,Iterations:n.Iterations,MaxIterations:n.MaxIterations,Trained:n.Trained};e.Models.push(o)}}})},null!=e.NetworkFile.name&&t.readAsText(e.NetworkFile)},e.RenderTestData=function(){var r=e.PlotWidth,a=e.PlotHeight,n=d3.select("#plot").attr("width",r).attr("height",a);n.selectAll("*").remove();var l=d3.scaleLinear().domain([0,200]).range([.1*r,.8*r]),i=d3.scaleLinear().domain([0,200]).range([.8*a,.1*a]),o=d3.scaleOrdinal().domain([0,d3.schemeCategory10.length-1]).range(d3.schemeCategory10);function s(e,t,r,a,n,s){e.append("line").attr("x1",l(t)).attr("y1",i(r)).attr("x2",l(a)).attr("y2",i(n)).attr("stroke-width",1).attr("stroke",o(s))}if(e.TestData.length>0&&e.Classification.length>0&&e.Classification.length==e.TestData.length){var c=n.append("g").classed("points_g",!0),d=function(e,t){for(var r=[],a=e.length,n=Number.MAX_VALUE,l=Number.MIN_VALUE,i=Number.MAX_VALUE,o=Number.MIN_VALUE,s=0;s<a;s++)n=Math.min(e[s][0],n),l=Math.max(e[s][0],l),i=Math.min(e[s][1],i),o=Math.max(e[s][1],o);var c=(l-n)/200,d=(o-i)/200;for(c=((l+=8*c)-(n-=8*c))/200,d=((o+=8*d)-(i-=8*d))/200,s=0;s<a;s++){var g={};g.x=(e[s][0]-n)/c,g.y=(e[s][1]-i)/d,g.color=t[s],r.push(g)}return r}(e.TestData,e.Classification);if(c.selectAll("circle").data(d).enter().append("circle").attr("cx",function(e){return l(e.x)}).attr("cy",function(e){return i(e.y)}).attr("r",5).style("fill",function(e){return o(parseInt(e.color))}),n.append("line").attr("x1",.1*r).attr("y1",.1*a).attr("x2",.8*r).attr("y2",.1*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.1*r).attr("y1",.8*a).attr("x2",.8*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.1*r).attr("y1",.1*a).attr("x2",.1*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.8*r).attr("y1",.1*a).attr("x2",.8*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),!e.Training&&e.TestData.length>0&&null!=e.Models&&e.plotContours){e.ClassifierProgress=0;var g=document.URL;e.asyncPlotter=t.create(function(e,t,r,a){var n=function(e,t,r){var a,n,l=e.length,i=new Array(t),o=new Array(r),s=Number.MAX_VALUE,c=Number.MIN_VALUE,d=Number.MAX_VALUE,g=Number.MIN_VALUE;for(a=0;a<l;a++)s=Math.min(e[a][0],s),c=Math.max(e[a][0],c),d=Math.min(e[a][1],d),g=Math.max(e[a][1],g);var p=(c-s)/t,u=(g-d)/r;for(p=((c+=8*p)-(s-=8*p))/t,u=((g+=8*u)-(d-=8*u))/r,n=0;n<t;n++)i[n]=s+n*p;for(a=0;a<r;a++)o[a]=d+a*u;var f=[];for(a=0;a<r;a++)for(n=0;n<t;n++)f.push([i[n],o[a]]);return{mesh:f,xplot:i,yplot:o,minx:s,miny:d,deltax:p,deltay:u}}(t,200,200),l=n.mesh,i=n.xplot,o=n.yplot,s=n.minx,c=n.miny,d=n.deltax,g=n.deltay;importScripts(e+"js/Models.js");var p=Matrix.Create(l.length,1);Matrix.Set(p,-1);var u,f,h,y=0;for(u=0;u<r.length;u++)if((0==a||a-1==u)&&r[u].Trained){y++;var m=new SupportVectorMachine;m.Initialize(r[u].ModelX,r[u].ModelY,r[u].Type,r[u].KernelParam,r[u].Alpha,r[u].B,r[u].W,r[u].MaxIterations,r[u].C,r[u].Category);for(var M=0;M<l.length;M+=100){var T=m.Predict(l.slice(M,M+100));for(f=0;f<T.length;f++)0!=a&&a-1==u?p[M+f][0]=T[f][0]:T[f][0]>p[M+f][0]&&(p[M+f][0]=T[f][0]);h=(u*l.length+M)/(r.length*l.length)*.25,notify({ClassifierProgress:h})}}var v=0,S=new Array(o.length);for(f=0;f<o.length;f++){S[f]=new Array(i.length),o[f]=(o[f]-c)/g;for(var C=0;C<i.length;C++)0==f&&(i[C]=(i[C]-s)/d),v>=0&&v<p.length&&(S[f][C]=p[v],h=.25+v/p.length*.25,notify({ClassifierProgress:h})),v++}var x=[];y>0&&function(e,t,r,a,n,l){for(var i=Math.abs(Math.min.apply(null,n)),o=0,s=0,c=0,d=0,g=new Array(5),p=new Array(5),u=new Array(5),f=new Array(5),h=t.length-1,y=t[0].length-1,m=n.length,M=[0,1,1,0],T=[0,0,1,1],v=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]],S=function(e,t){return(g[t]*u[e]-g[e]*u[t])/(g[t]-g[e])},C=function(e,t){return(g[t]*f[e]-g[e]*f[t])/(g[t]-g[e])},x=y-1;x>=0;x--)for(var P=0;P<=h-1;P++){var K=Math.min(t[P][x],t[P][x+1]),w=Math.min(t[P+1][x],t[P+1][x+1]),I=Math.min(K,w);K=Math.max(t[P][x],t[P][x+1]),w=Math.max(t[P+1][x],t[P+1][x+1]);var A,N=Math.max(K,w);if(N>=n[0]&&I<=n[m-1])for(A=0;A<m;A++)if(n[A]>=I&&n[A]<=N){var D;for(D=4;D>=0;D--)D>0?(g[D]=t[P+M[D-1]][x+T[D-1]]-n[A],u[D]=r[P+M[D-1]],f[D]=a[x+T[D-1]]):(g[0]=.25*(g[1]+g[2]+g[3]+g[4]),u[0]=.5*(r[P]+r[P+1]),f[0]=.5*(a[x]+a[x+1])),g[D]>0?p[D]=1:g[D]<0?p[D]=-1:p[D]=0;for(D=1;D<=4;D++){var k,b=D;k=4!=D?D+1:1;var F=v[p[b]+1][p[0]+1][p[k]+1];if(0!=F){switch(F){case 1:o=u[b],c=f[b],s=u[0],d=f[0];break;case 2:o=u[0],c=f[0],s=u[k],d=f[k];break;case 3:o=u[k],c=f[k],s=u[b],d=f[b];break;case 4:o=u[b],c=f[b],s=S(0,k),d=C(0,k);break;case 5:o=u[0],c=f[0],s=S(k,b),d=C(k,b);break;case 6:o=u[k],c=f[k],s=S(b,0),d=C(b,0);break;case 7:o=S(b,0),c=C(b,0),s=S(0,k),d=C(0,k);break;case 8:o=S(0,k),c=C(0,k),s=S(k,b),d=C(k,b);break;case 9:o=S(k,b),c=C(k,b),s=S(b,0),d=C(b,0)}l(e,c,o,d,s,i+n[A])}}}notify({ClassifierProgress:.5+((y-x-1)*(h+1)+P)/((y+1)*(h+1))*.5})}}(x,S,i,o,[-1,0,1],function(e,t,r,a,n,l){e.push({x1:t,y1:r,x2:a,y2:n,z:l})}),complete({lines:x})},{async:!0}),e.asyncPlotter.run(g,e.TestData,e.Models,e.SelectedModel).then(function(t){if(e.ClassifierProgress=1,null!=t.lines){var r=t.lines;!function(e,t){if(t.length>0)for(var r=0;r<t.length;r++)s(e,t[r].x1,t[r].y1,t[r].x2,t[r].y2,t[r].z)}(n,r)}},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncPlotter=null})}}},e.SaveRenderedData=function(){var t=$("#plot")[0].innerHTML;if(null!=t){(t="<svg>"+t+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(t=t.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),t.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(t=t.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.PlotWidth.toString()+'px" height="'+e.PlotHeight.toString()+'px"'));var n=new a([t],{type:"image/svg+xml;charset=utf-8"});r.saveAs(n,"Classification.svg")}}}]).directive("inputBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}}).directive("networkBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.NetworkFile=t.target.files[0]})})}});