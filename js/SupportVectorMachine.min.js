angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("SupportVectorMachineController",["$scope","Webworker","FileSaver","Blob",function(e,t,a,n){class r{constructor(e,t,a,n,r,l,i){this.index=e,this.Type=t,this.KernelParam=a,this.C=n,this.MaxIterations=r,this.Tolerance=l,this.Category=i}}e.Models=[],e.Normalization=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.Training=!1,e.TrainingProgress=0,e.Threshold=.9,e.ClassifierProgress=0,e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.asyncPlotter=void 0,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.TestData=[],e.Samples=0,e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.KernelType={Polynomial:0,Gaussian:1,Radial:2,Sigmoid:3,Linear:4,Fourier:5},e.KernelNames=["Polynomial","Gaussian","Radial","Sigmoid","Linear","Fourier"],e.kernel=e.KernelNames[0],e.SelectedKernel=0,e.bias=0,e.exponent=2,e.sigma=.01,e.slope=1,e.intercept=0,e.scalingFactor=1,e.category=0,e.regularization=1,e.passes=5,e.tolerance=1e-5,e.SelectedModel=0,e.PlotWidth=1024,e.PlotHeight=1024,e.SelectDelimiter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.SelectKernel=function(){var t=e.KernelNames.indexOf(e.kernel);e.SelectedKernel=t},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(a){e.$apply(function(){for(var a=t.result.split("\n"),n=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<a.length;r++){var l=[],i=a[r].trim().split(n);if(i.length>0){if(0==r&&i.length>1&&(e.Inputs=i.length-1),i.length>1){var o=parseInt(i[i.length-1]);e.Categories=Math.max(e.Categories,o),e.Output.push([o])}for(var s=0;s<i.length-1;s++)l.push(parseFloat(i[s]));l.length>0&&(e.TrainingData.push(l),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(a){e.$apply(function(){for(var a=t.result.split("\n"),n=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",r=0;r<a.length;r++){var l=[],i=a[r].trim().split(n);if(i.length>=e.Inputs){for(var o=0;o<i.length;o++)o>=0&&o<e.Inputs&&l.push(parseFloat(i[o]));l.length>0&&(e.TestData.push(l),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.RenumberModels=function(){for(var t=0;t<e.Models.length;t++)e.Models[t].index=t+1},e.AddModel=function(){if(0!=e.category&&e.Models.findIndex(t=>t.Category==e.category)<0){var t=void 0;if(e.SelectedKernel==e.KernelType.Polynomial)t=new r(e.Models.length+1,e.KernelType.Polynomial,[e.bias,e.exponent],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial)t=new r(e.Models.length+1,e.SelectedKernel==e.KernelType.Gaussian?e.KernelType.Gaussian:e.KernelType.Radial,[e.sigma],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear)t=new r(e.Models.length+1,e.SelectedKernel==e.KernelType.Sigmoid?e.KernelType.Sigmoid:e.KernelType.Linear,[e.slope,e.intercept],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Fourier)t=new r(e.Models.length+1,e.KernelType.Fourier,[e.scalingFactor],e.regularization,e.passes,e.tolerance,e.category);null!=t&&e.Models.push(t)}},e.SelectModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];e.kernel=e.KernelNames[t.Type],e.SelectedKernel=t.Type,t.Type==e.KernelType.Polynomial?(e.bias=t.KernelParam[0],e.exponent=t.KernelParam[1]):t.Type==e.KernelType.Gaussian||t.Type==e.KernelType.Radial?e.sigma=t.KernelParam[0]:t.Type==e.KernelType.Sigmoid||t.Type==e.KernelType.Linear?(e.slope=t.KernelParam[0],e.intercept=t.KernelParam[1]):t.Type==e.KernelType.Fourier&&(e.scalingFactor=t.KernelParam[0]),e.passes=t.MaxIterations,e.regularization=t.C,e.tolerance=t.Tolerance,e.category=t.Category}},e.RemoveModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var t=0;t<e.Models.length;t++)if(e.Models[t].index==e.SelectedModel){e.Models.splice(t,1);break}e.RenumberModels(),e.SelectedModel=0}},e.UpdateModel=function(){var t=e.SelectedModel-1;t>=0&&t<e.Models.length&&(e.Models[t].Type=e.SelectedKernel,e.SelectedKernel==e.KernelType.Polynomial?e.Models[t].KernelParam=[e.bias,e.exponent]:e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?e.Models[t].KernelParam=[e.sigma]:e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?e.Models[t].KernelParam=[e.slope,e.intercept]:e.SelectedKernel==e.KernelType.Fourier&&(e.Models[t].KernelParam=[e.scalingFactor]),e.Models[t].MaxIterations=e.passes,e.Models[t].C=e.regularization,e.Models[t].Tolerance=e.tolerance,e.Models[t].Category=e.category)},e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncClassifier=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Models.length>0&&e.TrainingData.length>0&&e.Output.length>0){var a=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,a,n){importScripts(e+"js/Models.min.js");for(var r=[],l=(new SupportVectorMachine,Matrix.Normalize(t)),i=[l.min,l.max],o=0;o<n.length;o++){var s=n[o],c=new SupportVectorMachine;c.Setup(t,a,s.C,s.Type,s.KernelParam,s.Tolerance,s.MaxIterations,s.Category),r.push(c)}for(var d=!(r.length>0);!d;){d=!0;var g=0,p=0;for(o=0;o<r.length;o++){var u=r[o].Step();g+=r[o].MaxIterations,p+=r[o].Iterations,u&&!r[o].Trained&&r[o].Generate(),d&=u}notify({Iterations:p,MaxIterations:g})}for(o=0;o<r.length;o++)r[o].index=o+1;complete({models:r,normalization:i})},{async:!0}),e.asyncTrainer.run(a,e.TrainingData,e.Output,e.Models).then(function(t){e.Models=t.models,e.Normalization=t.normalization,e.TrainingProgress=1,e.Training=!1,e.SelectedModel=0},null,function(t){e.TrainingProgress=t.Iterations/t.MaxIterations}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Models){var a=document.URL;e.asyncClassifier=t.create(function(e,t,a,n,r){importScripts(e+"js/Models.min.js");var l=Matrix.Create(t.length,1);Matrix.Set(l,0);var i=Matrix.Create(t.length,1);if(Matrix.Set(i,0),0!=n){var o=n-1;a[o].Trained&&((c=new SupportVectorMachine).Initialize(a[o].ModelX,a[o].ModelY,a[o].Type,a[o].KernelParam,a[o].Alpha,a[o].B,a[o].W,a[o].MaxIterations,a[o].C,a[o].Category),l=c.Classify(t,r),i=c.Predict(t,r))}else for(var s=0;s<a.length;s++)if(a[s].Trained){var c;(c=new SupportVectorMachine).Initialize(a[s].ModelX,a[s].ModelY,a[s].Type,a[s].KernelParam,a[s].Alpha,a[s].B,a[s].W,a[s].MaxIterations,a[s].C,a[s].Category);for(var d=0;d<t.length;d+=100)for(var g=c.Predict(t.slice(d,d+100)),p=0;p<g.length;p++)g[p][0]>i[d+p][0]&&(i[d+p][0]=g[p][0],l[d+p][0]=g[p][0]>=r?a[s].Category:0)}complete({classification:l,prediction:i})},{async:!0}),e.asyncClassifier.run(a,e.TestData,e.Models,e.SelectedModel,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var a=0;a<e.Classification.length;a++)a>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[a][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1},null,function(e){}).catch(function(t){e.asyncClassifier=null})}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.DisplayModelParameters=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];if(t.Trained){for(var a=[],n=0;n<t.W.length;n++)a.push(t.W[n][0]);var r={ModelX:t.ModelX,ModelY:t.ModelY,Type:t.Type,KernelParam:t.KernelParam,W:a,B:t.B,C:t.C,Tolerance:t.Tolerance,Category:t.Category,Passes:t.Iterations,Iterations:t.Iterations,MaxIterations:t.MaxIterations,Trained:t.Trained};e.modelParameters=e.PrettyPrint(r)}}},e.SaveModels=function(){if(null!=e.Models&&e.Normalization.length>1){for(var t=[],r=0;r<e.Models.length;r++){var l=e.Models[r];if(l.Trained){for(var i=[],o=0;o<l.W.length;o++)i.push(l.W[o][0]);var s={ModelX:l.ModelX,ModelY:l.ModelY,Type:l.Type,KernelParam:l.KernelParam,Alpha:l.Alpha,W:i,B:l.B,C:l.C,Tolerance:l.Tolerance,Category:l.Category,Passes:l.Iterations,Iterations:l.Iterations,MaxIterations:l.MaxIterations,Trained:l.Trained};t.push(s)}}var c={Models:t,Normalization:e.Normalization},d=JSON.stringify(c),g=new n([d],{type:"application/json"});a.saveAs(g,"Models.json")}},e.LoadSVM=function(){e.Models=[],e.Inputs=0,e.Categories=0,e.SelectedModel=0;var t=new FileReader;t.onload=function(a){e.$apply(function(){var a=JSON.parse(t.result);if(null!=a.Models&&null!=a.Normalization){e.Normalization=a.Normalization,e.Inputs=a.Models[0].ModelX[0].length;for(var n=0;n<a.Models.length;n++){var r=a.Models[n],l=[];e.Categories=Math.max(e.Categories,r.Category);for(var i=0;i<r.W.length;i++)l.push([r.W[i]]);var o={index:n+1,ModelX:r.ModelX,ModelY:r.ModelY,Type:r.Type,KernelParam:r.KernelParam,Alpha:r.Alpha,W:l,B:r.B,C:r.C,Tolerance:r.Tolerance,Category:r.Category,Passes:r.Iterations,Iterations:r.Iterations,MaxIterations:r.MaxIterations,Trained:r.Trained};e.Models.push(o)}}})},null!=e.NetworkFile.name&&t.readAsText(e.NetworkFile)},e.RenderTestData=function(){if(e.TestData.length>0&&e.Classification.length>0&&e.Classification.length==e.TestData.length&&null!=e.Normalization){var a=e.PlotWidth,n=e.PlotHeight,r=d3.scaleOrdinal(d3.schemeCategory10),l=d3.select("#plot").attr("width",a).attr("height",n);l.selectAll("*").remove();var o=d3.scaleLinear().domain([0,1]).range([.1*a,.8*a]),s=d3.scaleLinear().domain([0,1]).range([.8*n,.1*n]),c=(r=d3.scaleOrdinal(d3.schemeCategory10),l.append("g").classed("points_g",!0));data=function(e,t,a,n){var r=[],l=e.length;for(i=0;i<l;i++){var o={};o.x=(e[i][0]-a[0])/(n[0]-a[0]),o.y=(e[i][1]-a[1])/(n[1]-a[1]),o.color=t[i],r.push(o)}return r}(e.TestData,e.Classification,e.Normalization[0],e.Normalization[1]);var d=c.selectAll("circle").data(data);function g(e,t,a,n,l,i){e.append("line").attr("x1",o(t)).attr("y1",s(a)).attr("x2",o(n)).attr("y2",s(l)).attr("stroke-width",1).attr("stroke",r(i)).attr("fill","none")}d=d.enter().append("circle").attr("cx",function(e){return o(e.x)}).attr("cy",function(e){return s(e.y)}).attr("r",5).style("fill",function(e){return r(e.color)});var p=function(e,t,a){for(var n=e.length,r=new Array(t),l=new Array(a),i=Number.MAX_VALUE,o=Number.MIN_VALUE,s=Number.MAX_VALUE,c=Number.MIN_VALUE,d=0;d<n;d++)i=Math.min(e[d][0],i),o=Math.max(e[d][0],o),s=Math.min(e[d][1],s),c=Math.max(e[d][1],c);var g=(o-i)/t,p=(c-s)/a;g=((o+=8*g)-(i-=8*g))/t,p=((c+=8*p)-(s-=8*p))/a;for(var u=0;u<t;u++)r[u]=i+u*g;for(d=0;d<a;d++)l[d]=s+d*p;var f=[];for(d=0;d<a;d++)for(u=0;u<t;u++)f.push([r[u],l[d]]);return{mesh:f,xplot:r,yplot:l,minx:i,maxx:o,miny:s,maxy:c}}(e.TestData,200,200),u=p.mesh,f=p.xplot,m=p.yplot,y=p.minx,h=p.maxx,M=p.miny,T=p.maxy,v=[];if(!e.Training&&u.length>0&&null!=e.Models){var S=document.URL;e.asyncPlotter=t.create(function(e,t,a,n){importScripts(e+"js/Models.min.js");var r=Matrix.Create(t.length,1);Matrix.Set(r,0);for(var l=0;l<a.length;l++)if(a[l].Trained){var i=new SupportVectorMachine;i.Initialize(a[l].ModelX,a[l].ModelY,a[l].Type,a[l].KernelParam,a[l].Alpha,a[l].B,a[l].W,a[l].MaxIterations,a[l].C,a[l].Category);for(var o=0;o<t.length;o+=100)for(var s=i.Predict(t.slice(o,o+100)),c=0;c<s.length;c++)s[c][0]>r[o+c][0]&&(r[o+c][0]=s[c][0])}complete({prediction:r})},{async:!0}),e.asyncPlotter.run(S,u,e.Models,e.Threshold).then(function(e){if(null!=e.prediction){v=e.prediction;for(var t=0,a=new Array(m.length),n=0;n<m.length;n++){a[n]=new Array(f.length),m[n]=(m[n]-M)/(T-M);for(var r=0;r<f.length;r++)0==n&&(f[r]=(f[r]-y)/(h-y)),t>=0&&t<v.length&&(a[n][r]=v[t]),t++}!function(e,t,a,n,r,l){var i=Math.abs(Math.min.apply(null,r)),o=0,s=0,c=0,d=0,g=new Array(5),p=new Array(5),u=new Array(5),f=new Array(5),m=t.length-1,y=t[0].length-1,h=r.length,M=[0,1,1,0],T=[0,0,1,1],v=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]];xsect=function(e,t){return(g[t]*u[e]-g[e]*u[t])/(g[t]-g[e])},ysect=function(e,t){return(g[t]*f[e]-g[e]*f[t])/(g[t]-g[e])};for(var S=y-1;S>=0;S--){var x;for(x=0;x<=m-1;x++){var C=Math.min(t[x][S],t[x][S+1]),K=Math.min(t[x+1][S],t[x+1][S+1]),P=Math.min(C,K);C=Math.max(t[x][S],t[x][S+1]),K=Math.max(t[x+1][S],t[x+1][S+1]);var w,I=Math.max(C,K);if(I>=r[0]&&P<=r[h-1])for(w=0;w<h;w++)if(r[w]>=P&&r[w]<=I){var A;for(A=4;A>=0;A--)A>0?(g[A]=t[x+M[A-1]][S+T[A-1]]-r[w],u[A]=a[x+M[A-1]],f[A]=n[S+T[A-1]]):(g[0]=.25*(g[1]+g[2]+g[3]+g[4]),u[0]=.5*(a[x]+a[x+1]),f[0]=.5*(n[S]+n[S+1])),g[A]>0?p[A]=1:g[A]<0?p[A]=-1:p[A]=0;for(A=1;A<=4;A++){var D,N=A;D=4!=A?A+1:1;var F=v[p[N]+1][p[0]+1][p[D]+1];if(0!=F){switch(F){case 1:o=u[N],c=f[N],s=u[0],d=f[0];break;case 2:o=u[0],c=f[0],s=u[D],d=f[D];break;case 3:o=u[D],c=f[D],s=u[N],d=f[N];break;case 4:o=u[N],c=f[N],s=xsect(0,D),d=ysect(0,D);break;case 5:o=u[0],c=f[0],s=xsect(D,N),d=ysect(D,N);break;case 6:o=u[D],c=f[D],s=xsect(N,0),d=ysect(N,0);break;case 7:o=xsect(N,0),c=ysect(N,0),s=xsect(0,D),d=ysect(0,D);break;case 8:o=xsect(0,D),c=ysect(0,D),s=xsect(D,N),d=ysect(D,N);break;case 9:o=xsect(D,N),c=ysect(D,N),s=xsect(N,0),d=ysect(N,0)}l(e,c,o,d,s,i+r[w])}}}}}}(l,a,f,m,[-1,-.9,-.5,.5,.9,1],g)}},null,function(e){}).catch(function(t){e.asyncPlotter=null})}}},e.SaveRenderedData=function(){var t=$("#plot")[0].innerHTML;if(null!=t){(t="<svg>"+t+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(t=t.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),t.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(t=t.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.PlotWidth.toString()+'px" height="'+e.PlotHeight.toString()+'px"'));var r=new n([t],{type:"image/svg+xml;charset=utf-8"});a.saveAs(r,"Classification.svg")}}}]).directive("inputBind",function(){return function(e,t,a){t.bind("change",function(t){e.$apply(function(e){e[a.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testBind",function(){return function(e,t,a){t.bind("change",function(t){e.$apply(function(e){e[a.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}}).directive("networkBind",function(){return function(e,t,a){t.bind("change",function(t){e.$apply(function(e){e[a.name]=t.target.files,e.NetworkFile=t.target.files[0]})})}});