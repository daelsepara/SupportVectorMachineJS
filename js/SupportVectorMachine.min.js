angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("SupportVectorMachineController",["$scope","Webworker","FileSaver","Blob",function(e,t,r,a){class n{constructor(e,t,r,a,n,l,i){this.index=e,this.Type=t,this.KernelParam=r,this.C=a,this.MaxIterations=n,this.Tolerance=l,this.Category=i}}e.Models=[],e.Normalization=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.Training=!1,e.TrainingProgress=0,e.Threshold=.9,e.ClassifierProgress=0,e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.asyncPlotter=void 0,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.TestData=[],e.Samples=0,e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.KernelType={Polynomial:0,Gaussian:1,Radial:2,Sigmoid:3,Linear:4,Fourier:5},e.KernelNames=["Polynomial","Gaussian","Radial","Sigmoid","Linear","Fourier"],e.kernel=e.KernelNames[0],e.SelectedKernel=0,e.bias=0,e.exponent=2,e.sigma=.01,e.slope=1,e.intercept=0,e.scalingFactor=1,e.category=0,e.regularization=1,e.passes=5,e.tolerance=1e-5,e.SelectedModel=0,e.PlotWidth=1024,e.PlotHeight=1024,e.plotContours=!1,e.SelectDelimiter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.SelectKernel=function(){var t=e.KernelNames.indexOf(e.kernel);e.SelectedKernel=t},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>0){if(0==n&&i.length>1&&(e.Inputs=i.length-1),i.length>1){var o=parseInt(i[i.length-1]);e.Categories=Math.max(e.Categories,o),e.Output.push([o])}for(var s=0;s<i.length-1;s++)l.push(parseFloat(i[s]));l.length>0&&(e.TrainingData.push(l),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>=e.Inputs){for(var o=0;o<i.length;o++)o>=0&&o<e.Inputs&&l.push(parseFloat(i[o]));l.length>0&&(e.TestData.push(l),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.RenumberModels=function(){for(var t=0;t<e.Models.length;t++)e.Models[t].index=t+1},e.AddModel=function(){if(0!=e.category&&e.Models.findIndex(t=>t.Category==e.category)<0){var t=void 0;if(e.SelectedKernel==e.KernelType.Polynomial)t=new n(e.Models.length+1,e.KernelType.Polynomial,[e.bias,e.exponent],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial)t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Gaussian?e.KernelType.Gaussian:e.KernelType.Radial,[e.sigma],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear)t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Sigmoid?e.KernelType.Sigmoid:e.KernelType.Linear,[e.slope,e.intercept],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Fourier)t=new n(e.Models.length+1,e.KernelType.Fourier,[e.scalingFactor],e.regularization,e.passes,e.tolerance,e.category);null!=t&&e.Models.push(t)}},e.SelectModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];e.kernel=e.KernelNames[t.Type],e.SelectedKernel=t.Type,t.Type==e.KernelType.Polynomial?(e.bias=t.KernelParam[0],e.exponent=t.KernelParam[1]):t.Type==e.KernelType.Gaussian||t.Type==e.KernelType.Radial?e.sigma=t.KernelParam[0]:t.Type==e.KernelType.Sigmoid||t.Type==e.KernelType.Linear?(e.slope=t.KernelParam[0],e.intercept=t.KernelParam[1]):t.Type==e.KernelType.Fourier&&(e.scalingFactor=t.KernelParam[0]),e.passes=t.MaxIterations,e.regularization=t.C,e.tolerance=t.Tolerance,e.category=t.Category}},e.RemoveModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var t=0;t<e.Models.length;t++)if(e.Models[t].index==e.SelectedModel){e.Models.splice(t,1);break}e.RenumberModels(),e.SelectedModel=0}},e.UpdateModel=function(){var t=e.SelectedModel-1;t>=0&&t<e.Models.length&&(e.Models[t].Type=e.SelectedKernel,e.SelectedKernel==e.KernelType.Polynomial?e.Models[t].KernelParam=[e.bias,e.exponent]:e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?e.Models[t].KernelParam=[e.sigma]:e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?e.Models[t].KernelParam=[e.slope,e.intercept]:e.SelectedKernel==e.KernelType.Fourier&&(e.Models[t].KernelParam=[e.scalingFactor]),e.Models[t].MaxIterations=e.passes,e.Models[t].C=e.regularization,e.Models[t].Tolerance=e.tolerance,e.Models[t].Category=e.category)},e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncClassifier=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Models.length>0&&e.TrainingData.length>0&&e.Output.length>0){var r=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,r,a){importScripts(e+"js/Models.min.js");for(var n=[],l=(new SupportVectorMachine,Matrix.Normalize(t)),i=[l.min,l.max],o=0;o<a.length;o++){var s=a[o],c=new SupportVectorMachine;c.Setup(t,r,s.C,s.Type,s.KernelParam,s.Tolerance,s.MaxIterations,s.Category),n.push(c)}for(var d=!(n.length>0);!d;){d=!0;var g=0,f=0;for(o=0;o<n.length;o++){var p=n[o].Step();g+=n[o].MaxIterations,f+=n[o].Iterations,p&&!n[o].Trained&&n[o].Generate(),d&=p}notify({Iterations:f,MaxIterations:g})}for(o=0;o<n.length;o++)n[o].index=o+1;complete({models:n,normalization:i})},{async:!0}),e.asyncTrainer.run(r,e.TrainingData,e.Output,e.Models).then(function(t){e.Models=t.models,e.Normalization=t.normalization,e.TrainingProgress=1,e.Training=!1,e.SelectedModel=0},null,function(t){e.TrainingProgress=t.Iterations/t.MaxIterations}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Models){e.ClassifierProgress=0;var r=document.URL;e.asyncClassifier=t.create(function(e,t,r,a,n){importScripts(e+"js/Models.min.js");var l=Matrix.Create(t.length,1);Matrix.Set(l,0);var i=Matrix.Create(t.length,1);if(Matrix.Set(i,0),0!=a){var o=a-1;if(r[o].Trained){(p=new SupportVectorMachine).Initialize(r[o].ModelX,r[o].ModelY,r[o].Type,r[o].KernelParam,r[o].Alpha,r[o].B,r[o].W,r[o].MaxIterations,r[o].C,r[o].Category);for(var s=0;s<t.length;s+=100){for(var c=p.Predict(t.slice(s,s+100)),d=0;d<c.length;d++)c[d][0]>i[s+d][0]&&(i[s+d][0]=c[d][0],l[s+d][0]=c[d][0]>=n?p.Category:0);var g=s/t.length;notify({ClassifierProgress:g})}}}else for(var f=0;f<r.length;f++)if(r[f].Trained){var p;for((p=new SupportVectorMachine).Initialize(r[f].ModelX,r[f].ModelY,r[f].Type,r[f].KernelParam,r[f].Alpha,r[f].B,r[f].W,r[f].MaxIterations,r[f].C,r[f].Category),s=0;s<t.length;s+=100){for(c=p.Predict(t.slice(s,s+100)),d=0;d<c.length;d++)c[d][0]>i[s+d][0]&&(i[s+d][0]=c[d][0],l[s+d][0]=c[d][0]>=n?r[f].Category:0);g=(f*t.length+s)/(r.length*t.length),notify({ClassifierProgress:g})}}complete({classification:l,prediction:i})},{async:!0}),e.asyncClassifier.run(r,e.TestData,e.Models,e.SelectedModel,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var r=0;r<e.Classification.length;r++)r>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[r][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncClassifier=null})}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.DisplayModelParameters=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];if(t.Trained){for(var r=[],a=0;a<t.W.length;a++)r.push(t.W[a][0]);var n={ModelX:t.ModelX,ModelY:t.ModelY,Type:t.Type,KernelParam:t.KernelParam,W:r,B:t.B,C:t.C,Tolerance:t.Tolerance,Category:t.Category,Passes:t.Iterations,Iterations:t.Iterations,MaxIterations:t.MaxIterations,Trained:t.Trained};e.modelParameters=e.PrettyPrint(n)}}},e.SaveModels=function(){if(null!=e.Models&&e.Normalization.length>1){for(var t=[],n=0;n<e.Models.length;n++){var l=e.Models[n];if(l.Trained){for(var i=[],o=0;o<l.W.length;o++)i.push(l.W[o][0]);var s={ModelX:l.ModelX,ModelY:l.ModelY,Type:l.Type,KernelParam:l.KernelParam,Alpha:l.Alpha,W:i,B:l.B,C:l.C,Tolerance:l.Tolerance,Category:l.Category,Passes:l.Iterations,Iterations:l.Iterations,MaxIterations:l.MaxIterations,Trained:l.Trained};t.push(s)}}var c={Models:t,Normalization:e.Normalization},d=JSON.stringify(c),g=new a([d],{type:"application/json"});r.saveAs(g,"Models.json")}},e.LoadSVM=function(){e.Models=[],e.Inputs=0,e.Categories=0,e.SelectedModel=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){var r=JSON.parse(t.result);if(null!=r.Models&&null!=r.Normalization){e.Normalization=r.Normalization,e.Inputs=r.Models[0].ModelX[0].length;for(var a=0;a<r.Models.length;a++){var n=r.Models[a],l=[];e.Categories=Math.max(e.Categories,n.Category);for(var i=0;i<n.W.length;i++)l.push([n.W[i]]);var o={index:a+1,ModelX:n.ModelX,ModelY:n.ModelY,Type:n.Type,KernelParam:n.KernelParam,Alpha:n.Alpha,W:l,B:n.B,C:n.C,Tolerance:n.Tolerance,Category:n.Category,Passes:n.Iterations,Iterations:n.Iterations,MaxIterations:n.MaxIterations,Trained:n.Trained};e.Models.push(o)}}})},null!=e.NetworkFile.name&&t.readAsText(e.NetworkFile)},e.RenderTestData=function(){if(e.TestData.length>0&&e.Classification.length>0&&e.Classification.length==e.TestData.length&&null!=e.Normalization){var r=e.PlotWidth,a=e.PlotHeight,n=d3.scaleOrdinal(d3.schemeCategory10),l=d3.select("#plot").attr("width",r).attr("height",a);l.selectAll("*").remove();var o=d3.scaleLinear().domain([0,1]).range([.1*r,.8*r]),s=d3.scaleLinear().domain([0,1]).range([.8*a,.1*a]),c=(n=d3.scaleOrdinal(d3.schemeCategory10),l.append("g").classed("points_g",!0));data=function(e,t,r,a){var n=[],l=e.length;for(i=0;i<l;i++){var o={};o.x=(e[i][0]-r[0])/(a[0]-r[0]),o.y=(e[i][1]-r[1])/(a[1]-r[1]),o.color=t[i],n.push(o)}return n}(e.TestData,e.Classification,e.Normalization[0],e.Normalization[1]);var d=c.selectAll("circle").data(data);function g(e,t,r,a,l,i){e.append("line").attr("x1",o(t)).attr("y1",s(r)).attr("x2",o(a)).attr("y2",s(l)).attr("stroke-width",1).attr("stroke",n(Math.abs(i))).attr("fill","none")}if(d=d.enter().append("circle").attr("cx",function(e){return o(e.x)}).attr("cy",function(e){return s(e.y)}).attr("r",5).style("fill",function(e){return n(e.color)}),!e.Training&&e.TestData.length>0&&null!=e.Models&&e.plotContours){e.ClassifierProgress=0;var f=document.URL;e.asyncPlotter=t.create(function(e,t,r,a){var n=function(e,t,r){for(var a=e.length,n=new Array(t),l=new Array(r),i=Number.MAX_VALUE,o=Number.MIN_VALUE,s=Number.MAX_VALUE,c=Number.MIN_VALUE,d=0;d<a;d++)i=Math.min(e[d][0],i),o=Math.max(e[d][0],o),s=Math.min(e[d][1],s),c=Math.max(e[d][1],c);var g=(o-i)/t,f=(c-s)/r;g=((o+=8*g)-(i-=8*g))/t,f=((c+=8*f)-(s-=8*f))/r;for(var p=0;p<t;p++)n[p]=i+p*g;for(d=0;d<r;d++)l[d]=s+d*f;var u=[];for(d=0;d<r;d++)for(p=0;p<t;p++)u.push([n[p],l[d]]);return{mesh:u,xplot:n,yplot:l,minx:i,maxx:o,miny:s,maxy:c}}(t,200,200),l=n.mesh,i=n.xplot,o=n.yplot,s=n.minx,c=n.maxx,d=n.miny,g=n.maxy;importScripts(e+"js/Models.min.js");var f=Matrix.Create(l.length,1);Matrix.Set(f,0);for(var p=0;p<r.length;p++)if(r[p].Trained){var u=new SupportVectorMachine;u.Initialize(r[p].ModelX,r[p].ModelY,r[p].Type,r[p].KernelParam,r[p].Alpha,r[p].B,r[p].W,r[p].MaxIterations,r[p].C,r[p].Category);for(var h=0;h<l.length;h+=100){for(var y=u.Predict(l.slice(h,h+100)),m=0;m<y.length;m++)y[m][0]>f[h+m][0]&&(f[h+m][0]=y[m][0]);var M=(p*l.length+h)/(r.length*l.length)*.25;notify({ClassifierProgress:M})}}var T=0,v=new Array(o.length);for(m=0;m<o.length;m++){v[m]=new Array(i.length),o[m]=(o[m]-d)/(g-d);for(var S=0;S<i.length;S++)0==m&&(i[S]=(i[S]-s)/(c-s)),T>=0&&T<f.length&&(v[m][S]=f[T],M=.25+T/f.length*.25,notify({ClassifierProgress:M})),T++}var C=[];!function(e,t,r,a,n,l){var i=Math.abs(Math.min.apply(null,n)),o=0,s=0,c=0,d=0,g=new Array(5),f=new Array(5),p=new Array(5),u=new Array(5),h=t.length-1,y=t[0].length-1,m=n.length,M=[0,1,1,0],T=[0,0,1,1],v=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]];xsect=function(e,t){return(g[t]*p[e]-g[e]*p[t])/(g[t]-g[e])},ysect=function(e,t){return(g[t]*u[e]-g[e]*u[t])/(g[t]-g[e])};for(var S=y-1;S>=0;S--)for(var C=0;C<=h-1;C++){var x=Math.min(t[C][S],t[C][S+1]),P=Math.min(t[C+1][S],t[C+1][S+1]),K=Math.min(x,P);x=Math.max(t[C][S],t[C][S+1]),P=Math.max(t[C+1][S],t[C+1][S+1]);var w,I=Math.max(x,P);if(I>=n[0]&&K<=n[m-1])for(w=0;w<m;w++)if(n[w]>=K&&n[w]<=I){var D;for(D=4;D>=0;D--)D>0?(g[D]=t[C+M[D-1]][S+T[D-1]]-n[w],p[D]=r[C+M[D-1]],u[D]=a[S+T[D-1]]):(g[0]=.25*(g[1]+g[2]+g[3]+g[4]),p[0]=.5*(r[C]+r[C+1]),u[0]=.5*(a[S]+a[S+1])),g[D]>0?f[D]=1:g[D]<0?f[D]=-1:f[D]=0;for(D=1;D<=4;D++){var A,N=D;A=4!=D?D+1:1;var F=v[f[N]+1][f[0]+1][f[A]+1];if(0!=F){switch(F){case 1:o=p[N],c=u[N],s=p[0],d=u[0];break;case 2:o=p[0],c=u[0],s=p[A],d=u[A];break;case 3:o=p[A],c=u[A],s=p[N],d=u[N];break;case 4:o=p[N],c=u[N],s=xsect(0,A),d=ysect(0,A);break;case 5:o=p[0],c=u[0],s=xsect(A,N),d=ysect(A,N);break;case 6:o=p[A],c=u[A],s=xsect(N,0),d=ysect(N,0);break;case 7:o=xsect(N,0),c=ysect(N,0),s=xsect(0,A),d=ysect(0,A);break;case 8:o=xsect(0,A),c=ysect(0,A),s=xsect(A,N),d=ysect(A,N);break;case 9:o=xsect(A,N),c=ysect(A,N),s=xsect(N,0),d=ysect(N,0)}l(e,c,o,d,s,i+n[w])}}}notify({ClassifierProgress:.5+((y-S-1)*(h+1)+C)/((y+1)*(h+1))*.5})}}(C,v,i,o,[-1,-.9,-.5,0,.5,.9,1],function(e,t,r,a,n,l){e.push({x1:t,y1:r,x2:a,y2:n,z:l})}),complete({lines:C})},{async:!0}),e.asyncPlotter.run(f,e.TestData,e.Models,e.Threshold).then(function(t){if(e.ClassifierProgress=1,null!=t.lines){var r=t.lines;!function(e,t){if(t.length>0)for(var r=0;r<t.length;r++)g(e,t[r].x1,t[r].y1,t[r].x2,t[r].y2,t[r].z)}(l,r)}},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncPlotter=null})}}},e.SaveRenderedData=function(){var t=$("#plot")[0].innerHTML;if(null!=t){(t="<svg>"+t+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(t=t.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),t.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(t=t.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.PlotWidth.toString()+'px" height="'+e.PlotHeight.toString()+'px"'));var n=new a([t],{type:"image/svg+xml;charset=utf-8"});r.saveAs(n,"Classification.svg")}}}]).directive("inputBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}}).directive("networkBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.NetworkFile=t.target.files[0]})})}});