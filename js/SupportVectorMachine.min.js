angular.module("d3",[]).factory("d3Service",[function(){return d3}]),angular.module("DeepLearning",["ngWebworker","ngFileSaver","d3"]).controller("SupportVectorMachineController",["$scope","Webworker","FileSaver","Blob",function(e,t,r,a){class n{constructor(e,t,r,a,n,l,i){this.index=e,this.Type=t,this.KernelParam=r,this.C=a,this.MaxIterations=n,this.Tolerance=l,this.Category=i}}e.Models=[],e.Normalization=[],e.Classification=[],e.Prediction=[],e.TrainingData=[],e.Output=[],e.Inputs=0,e.Categories=0,e.Items=0,e.Training=!1,e.TrainingProgress=0,e.Threshold=.9,e.ClassifierProgress=0,e.asyncTrainer=void 0,e.asyncClassifier=void 0,e.asyncPlotter=void 0,e.SelectedFile={},e.TestFile={},e.NetworkFile={},e.TestData=[],e.Samples=0,e.DelimiterNames=["Tab \\t","Comma ,","Space \\s","Vertical Pipe |","Colon :","Semi-Colon ;","Forward Slash /","/","Backward Slash \\"],e.Delimiters=["\t",","," ","|",":",";","/","\\"],e.delimiter=e.DelimiterNames[0],e.SelectedDelimiter=0,e.KernelType={Polynomial:0,Gaussian:1,Radial:2,Sigmoid:3,Linear:4,Fourier:5},e.KernelNames=["Polynomial","Gaussian","Radial","Sigmoid","Linear","Fourier"],e.kernel=e.KernelNames[0],e.SelectedKernel=0,e.bias=0,e.exponent=2,e.sigma=.01,e.slope=1,e.intercept=0,e.scalingFactor=1,e.category=0,e.regularization=1,e.passes=5,e.tolerance=1e-5,e.SelectedModel=0,e.PlotWidth=1024,e.PlotHeight=1024,e.plotContours=!1,e.SelectDelimiter=function(){var t=e.DelimiterNames.indexOf(e.delimiter);e.SelectedDelimiter=t+1},e.SelectKernel=function(){var t=e.KernelNames.indexOf(e.kernel);e.SelectedKernel=t},e.ReadTrainingData=function(){e.TrainingData=[],e.Output=[],e.Items=0,e.Categories=0,e.Inputs=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>0){if(0==n&&i.length>1&&(e.Inputs=i.length-1),i.length>1){var s=parseInt(i[i.length-1]);e.Categories=Math.max(e.Categories,s),e.Output.push([s])}for(var o=0;o<i.length-1;o++)l.push(parseFloat(i[o]));l.length>0&&(e.TrainingData.push(l),e.Items++)}}e.fileContent=t.result.trim()})},null!=e.SelectedFile.name&&t.readAsText(e.SelectedFile)},e.ReadTestData=function(){e.TestData=[],e.Samples=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){for(var r=t.result.split("\n"),a=e.SelectedDelimiter>0?e.Delimiters[e.SelectedDelimiter-1]:"\t",n=0;n<r.length;n++){var l=[],i=r[n].trim().split(a);if(i.length>=e.Inputs){for(var s=0;s<i.length;s++)s>=0&&s<e.Inputs&&l.push(parseFloat(i[s]));l.length>0&&(e.TestData.push(l),e.Samples++)}}e.testContent=t.result.trim()})},null!=e.TestFile.name&&t.readAsText(e.TestFile)},e.RenumberModels=function(){for(var t=0;t<e.Models.length;t++)e.Models[t].index=t+1},e.AddModel=function(){if(0!=e.category&&e.Models.findIndex(t=>t.Category==e.category)<0){var t=void 0;if(e.SelectedKernel==e.KernelType.Polynomial)t=new n(e.Models.length+1,e.KernelType.Polynomial,[e.bias,e.exponent],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial)t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Gaussian?e.KernelType.Gaussian:e.KernelType.Radial,[e.sigma],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear)t=new n(e.Models.length+1,e.SelectedKernel==e.KernelType.Sigmoid?e.KernelType.Sigmoid:e.KernelType.Linear,[e.slope,e.intercept],e.regularization,e.passes,e.tolerance,e.category);else if(e.SelectedKernel==e.KernelType.Fourier)t=new n(e.Models.length+1,e.KernelType.Fourier,[e.scalingFactor],e.regularization,e.passes,e.tolerance,e.category);null!=t&&e.Models.push(t)}},e.SelectModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];e.kernel=e.KernelNames[t.Type],e.SelectedKernel=t.Type,t.Type==e.KernelType.Polynomial?(e.bias=t.KernelParam[0],e.exponent=t.KernelParam[1]):t.Type==e.KernelType.Gaussian||t.Type==e.KernelType.Radial?e.sigma=t.KernelParam[0]:t.Type==e.KernelType.Sigmoid||t.Type==e.KernelType.Linear?(e.slope=t.KernelParam[0],e.intercept=t.KernelParam[1]):t.Type==e.KernelType.Fourier&&(e.scalingFactor=t.KernelParam[0]),e.passes=t.MaxIterations,e.regularization=t.C,e.tolerance=t.Tolerance,e.category=t.Category}},e.RemoveModel=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){for(var t=0;t<e.Models.length;t++)if(e.Models[t].index==e.SelectedModel){e.Models.splice(t,1);break}e.RenumberModels(),e.SelectedModel=0}},e.UpdateModel=function(){var t=e.SelectedModel-1;t>=0&&t<e.Models.length&&(e.Models[t].Type=e.SelectedKernel,e.SelectedKernel==e.KernelType.Polynomial?e.Models[t].KernelParam=[e.bias,e.exponent]:e.SelectedKernel==e.KernelType.Gaussian||e.SelectedKernel==e.KernelType.Radial?e.Models[t].KernelParam=[e.sigma]:e.SelectedKernel==e.KernelType.Sigmoid||e.SelectedKernel==e.KernelType.Linear?e.Models[t].KernelParam=[e.slope,e.intercept]:e.SelectedKernel==e.KernelType.Fourier&&(e.Models[t].KernelParam=[e.scalingFactor]),e.Models[t].MaxIterations=e.passes,e.Models[t].C=e.regularization,e.Models[t].Tolerance=e.tolerance,e.Models[t].Category=e.category)},e.StopAsyncTrainer=function(){if(e.asyncTrainer)try{e.asyncTrainer.terminate(),e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}catch(t){e.asyncTrainer=null,e.Training=!1,e.TrainingProgress=0}},e.StopAsyncClassifier=function(){if(e.asyncClassifier)try{e.asyncClassifier.terminate(),e.asyncClassifier=null,e.ClassifierProgress=0}catch(t){e.asyncClassifier=null,e.ClassifierProgress=0}},e.AsyncTrainer=function(){if(!e.Training&&e.Models.length>0&&e.TrainingData.length>0&&e.Output.length>0){var r=document.URL;e.Training=!0,e.asyncTrainer=t.create(function(e,t,r,a){importScripts(e+"js/Models.min.js");for(var n=[],l=(new SupportVectorMachine,Matrix.Normalize(t)),i=[l.min,l.max],s=0;s<a.length;s++){var o=a[s],c=new SupportVectorMachine;c.Setup(t,r,o.C,o.Type,o.KernelParam,o.Tolerance,o.MaxIterations,o.Category),n.push(c)}for(var d=!(n.length>0);!d;){d=!0;var g=0,p=0;for(s=0;s<n.length;s++){var f=n[s].Step();g+=n[s].MaxIterations,p+=n[s].Iterations,f&&!n[s].Trained&&n[s].Generate(),d&=f}notify({Iterations:p,MaxIterations:g})}for(s=0;s<n.length;s++)n[s].index=s+1;complete({models:n,normalization:i})},{async:!0}),e.asyncTrainer.run(r,e.TrainingData,e.Output,e.Models).then(function(t){e.Models=t.models,e.Normalization=t.normalization,e.TrainingProgress=1,e.Training=!1,e.SelectedModel=0},null,function(t){e.TrainingProgress=t.Iterations/t.MaxIterations}).catch(function(t){e.asyncTrainer=null})}},e.AsyncClassifier=function(){if(!e.Training&&e.Samples>0&&e.Inputs>0&&e.TestData.length>0&&null!=e.Models){e.ClassifierProgress=0;var r=document.URL;e.asyncClassifier=t.create(function(e,t,r,a,n){importScripts(e+"js/Models.min.js");var l=Matrix.Create(t.length,1);Matrix.Set(l,0);var i=Matrix.Create(t.length,1);if(Matrix.Set(i,0),0!=a){var s=a-1;if(r[s].Trained){(f=new SupportVectorMachine).Initialize(r[s].ModelX,r[s].ModelY,r[s].Type,r[s].KernelParam,r[s].Alpha,r[s].B,r[s].W,r[s].MaxIterations,r[s].C,r[s].Category);for(var o=0;o<t.length;o+=100){for(var c=f.Predict(t.slice(o,o+100)),d=0;d<c.length;d++)c[d][0]>i[o+d][0]&&(i[o+d][0]=c[d][0],l[o+d][0]=c[d][0]>=n?f.Category:0);var g=o/t.length;notify({ClassifierProgress:g})}}}else for(var p=0;p<r.length;p++)if(r[p].Trained){var f;for((f=new SupportVectorMachine).Initialize(r[p].ModelX,r[p].ModelY,r[p].Type,r[p].KernelParam,r[p].Alpha,r[p].B,r[p].W,r[p].MaxIterations,r[p].C,r[p].Category),o=0;o<t.length;o+=100){for(c=f.Predict(t.slice(o,o+100)),d=0;d<c.length;d++)c[d][0]>i[o+d][0]&&(i[o+d][0]=c[d][0],l[o+d][0]=c[d][0]>=n?r[p].Category:0);g=(p*t.length+o)/(r.length*t.length),notify({ClassifierProgress:g})}}complete({classification:l,prediction:i})},{async:!0}),e.asyncClassifier.run(r,e.TestData,e.Models,e.SelectedModel,e.Threshold).then(function(t){if(e.classificationResult="",null!=t.classification){e.Classification=t.classification;for(var r=0;r<e.Classification.length;r++)r>0&&(e.classificationResult+="\n"),e.classificationResult+=e.Classification[r][0].toString()}null!=t.prediction&&(e.Prediction=t.prediction),e.ClassifierProgress=1,d3.select("#plot").selectAll("*").remove()},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncClassifier=null})}},e.PrettyPrint=function(e){return JSON.stringify(e,void 0,4)},e.DisplayModelParameters=function(){if(e.SelectedModel>0&&e.SelectedModel<=e.Models.length){var t=e.Models[e.SelectedModel-1];if(t.Trained){for(var r=[],a=0;a<t.W.length;a++)r.push(t.W[a][0]);var n={ModelX:t.ModelX,ModelY:t.ModelY,Type:t.Type,KernelParam:t.KernelParam,W:r,B:t.B,C:t.C,Tolerance:t.Tolerance,Category:t.Category,Passes:t.Iterations,Iterations:t.Iterations,MaxIterations:t.MaxIterations,Trained:t.Trained};e.modelParameters=e.PrettyPrint(n)}}},e.SaveModels=function(){if(null!=e.Models&&e.Normalization.length>1){for(var t=[],n=0;n<e.Models.length;n++){var l=e.Models[n];if(l.Trained){for(var i=[],s=0;s<l.W.length;s++)i.push(l.W[s][0]);var o={ModelX:l.ModelX,ModelY:l.ModelY,Type:l.Type,KernelParam:l.KernelParam,Alpha:l.Alpha,W:i,B:l.B,C:l.C,Tolerance:l.Tolerance,Category:l.Category,Passes:l.Iterations,Iterations:l.Iterations,MaxIterations:l.MaxIterations,Trained:l.Trained};t.push(o)}}var c={Models:t,Normalization:e.Normalization},d=JSON.stringify(c),g=new a([d],{type:"application/json"});r.saveAs(g,"Models.json")}},e.LoadSVM=function(){e.Models=[],e.Inputs=0,e.Categories=0,e.SelectedModel=0;var t=new FileReader;t.onload=function(r){e.$apply(function(){var r=JSON.parse(t.result);if(null!=r.Models&&null!=r.Normalization){e.Normalization=r.Normalization,e.Inputs=r.Models[0].ModelX[0].length;for(var a=0;a<r.Models.length;a++){var n=r.Models[a],l=[];e.Categories=Math.max(e.Categories,n.Category);for(var i=0;i<n.W.length;i++)l.push([n.W[i]]);var s={index:a+1,ModelX:n.ModelX,ModelY:n.ModelY,Type:n.Type,KernelParam:n.KernelParam,Alpha:n.Alpha,W:l,B:n.B,C:n.C,Tolerance:n.Tolerance,Category:n.Category,Passes:n.Iterations,Iterations:n.Iterations,MaxIterations:n.MaxIterations,Trained:n.Trained};e.Models.push(s)}}})},null!=e.NetworkFile.name&&t.readAsText(e.NetworkFile)},e.RenderTestData=function(){if(e.TestData.length>0&&e.Classification.length>0&&e.Classification.length==e.TestData.length){var r=e.PlotWidth,a=e.PlotHeight,n=d3.select("#plot").attr("width",r).attr("height",a);n.selectAll("*").remove();var l=d3.scaleLinear().domain([0,200]).range([.1*r,.8*r]),i=d3.scaleLinear().domain([0,200]).range([.8*a,.1*a]),s=d3.scaleOrdinal().domain([0,d3.schemeCategory10.length-1]).range(d3.schemeCategory10),o=n.append("g").classed("points_g",!0);data=function(e,t){for(var r=[],a=e.length,n=Number.MAX_VALUE,l=Number.MIN_VALUE,i=Number.MAX_VALUE,s=Number.MIN_VALUE,o=0;o<a;o++)n=Math.min(e[o][0],n),l=Math.max(e[o][0],l),i=Math.min(e[o][1],i),s=Math.max(e[o][1],s);var c=(l-n)/200,d=(s-i)/200;for(c=((l+=8*c)-(n-=8*c))/200,d=((s+=8*d)-(i-=8*d))/200,o=0;o<a;o++){var g={};g.x=(e[o][0]-n)/c,g.y=(e[o][1]-i)/d,g.color=t[o],r.push(g)}return r}(e.TestData,e.Classification);var c=o.selectAll("circle").data(data);function d(e,t,r,a,n,o){e.append("line").attr("x1",l(t)).attr("y1",i(r)).attr("x2",l(a)).attr("y2",i(n)).attr("stroke-width",1).attr("stroke",s(o))}if(c=c.enter().append("circle").attr("cx",function(e){return l(e.x)}).attr("cy",function(e){return i(e.y)}).attr("r",5).style("fill",function(e){return s(parseInt(e.color))}),n.append("line").attr("x1",.1*r).attr("y1",.1*a).attr("x2",.8*r).attr("y2",.1*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.1*r).attr("y1",.8*a).attr("x2",.8*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.1*r).attr("y1",.1*a).attr("x2",.1*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),n.append("line").attr("x1",.8*r).attr("y1",.1*a).attr("x2",.8*r).attr("y2",.8*a).attr("stroke-width",1).attr("stroke","#000000"),!e.Training&&e.TestData.length>0&&null!=e.Models&&e.plotContours){e.ClassifierProgress=0;var g=document.URL;e.asyncPlotter=t.create(function(e,t,r,a,n){var l=function(e,t,r){for(var a=e.length,n=new Array(t),l=new Array(r),i=Number.MAX_VALUE,s=Number.MIN_VALUE,o=Number.MAX_VALUE,c=Number.MIN_VALUE,d=0;d<a;d++)i=Math.min(e[d][0],i),s=Math.max(e[d][0],s),o=Math.min(e[d][1],o),c=Math.max(e[d][1],c);var g=(s-i)/t,p=(c-o)/r;g=((s+=8*g)-(i-=8*g))/t,p=((c+=8*p)-(o-=8*p))/r;for(var f=0;f<t;f++)n[f]=i+f*g;for(d=0;d<r;d++)l[d]=o+d*p;var u=[];for(d=0;d<r;d++)for(f=0;f<t;f++)u.push([n[f],l[d]]);return{mesh:u,xplot:n,yplot:l,minx:i,miny:o,deltax:g,deltay:p}}(t,200,200),i=l.mesh,s=l.xplot,o=l.yplot,c=l.minx,d=l.miny,g=l.deltax,p=l.deltay;importScripts(e+"js/Models.min.js");var f=Matrix.Create(i.length,1);Matrix.Set(f,-1);for(var u=0;u<r.length;u++)if((0==a||a-1==u)&&r[u].Trained){var h=new SupportVectorMachine;h.Initialize(r[u].ModelX,r[u].ModelY,r[u].Type,r[u].KernelParam,r[u].Alpha,r[u].B,r[u].W,r[u].MaxIterations,r[u].C,r[u].Category);for(var y=0;y<i.length;y+=100){for(var m=h.Predict(i.slice(y,y+100)),M=0;M<m.length;M++)0!=a&&a-1==u?f[y+M][0]=m[M][0]:m[M][0]>f[y+M][0]&&(f[y+M][0]=m[M][0]);var T=(u*i.length+y)/(r.length*i.length)*.25;notify({ClassifierProgress:T})}}var v=0,S=new Array(o.length);for(M=0;M<o.length;M++){S[M]=new Array(s.length),o[M]=(o[M]-d)/p;for(var x=0;x<s.length;x++)0==M&&(s[x]=(s[x]-c)/g),v>=0&&v<f.length&&(S[M][x]=f[v],T=.25+v/f.length*.25,notify({ClassifierProgress:T})),v++}var C=[];!function(e,t,r,a,n,l){var i=Math.abs(Math.min.apply(null,n)),s=0,o=0,c=0,d=0,g=new Array(5),p=new Array(5),f=new Array(5),u=new Array(5),h=t.length-1,y=t[0].length-1,m=n.length,M=[0,1,1,0],T=[0,0,1,1],v=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]];xsect=function(e,t){return(g[t]*f[e]-g[e]*f[t])/(g[t]-g[e])},ysect=function(e,t){return(g[t]*u[e]-g[e]*u[t])/(g[t]-g[e])};for(var S=y-1;S>=0;S--)for(var x=0;x<=h-1;x++){var C=Math.min(t[x][S],t[x][S+1]),P=Math.min(t[x+1][S],t[x+1][S+1]),K=Math.min(C,P);C=Math.max(t[x][S],t[x][S+1]),P=Math.max(t[x+1][S],t[x+1][S+1]);var w,I=Math.max(C,P);if(I>=n[0]&&K<=n[m-1])for(w=0;w<m;w++)if(n[w]>=K&&n[w]<=I){var A;for(A=4;A>=0;A--)A>0?(g[A]=t[x+M[A-1]][S+T[A-1]]-n[w],f[A]=r[x+M[A-1]],u[A]=a[S+T[A-1]]):(g[0]=.25*(g[1]+g[2]+g[3]+g[4]),f[0]=.5*(r[x]+r[x+1]),u[0]=.5*(a[S]+a[S+1])),g[A]>0?p[A]=1:g[A]<0?p[A]=-1:p[A]=0;for(A=1;A<=4;A++){var N,D=A;N=4!=A?A+1:1;var k=v[p[D]+1][p[0]+1][p[N]+1];if(0!=k){switch(k){case 1:s=f[D],c=u[D],o=f[0],d=u[0];break;case 2:s=f[0],c=u[0],o=f[N],d=u[N];break;case 3:s=f[N],c=u[N],o=f[D],d=u[D];break;case 4:s=f[D],c=u[D],o=xsect(0,N),d=ysect(0,N);break;case 5:s=f[0],c=u[0],o=xsect(N,D),d=ysect(N,D);break;case 6:s=f[N],c=u[N],o=xsect(D,0),d=ysect(D,0);break;case 7:s=xsect(D,0),c=ysect(D,0),o=xsect(0,N),d=ysect(0,N);break;case 8:s=xsect(0,N),c=ysect(0,N),o=xsect(N,D),d=ysect(N,D);break;case 9:s=xsect(N,D),c=ysect(N,D),o=xsect(D,0),d=ysect(D,0)}l(e,c,s,d,o,i+n[w])}}}notify({ClassifierProgress:.5+((y-S-1)*(h+1)+x)/((y+1)*(h+1))*.5})}}(C,S,s,o,[-1,0,1],function(e,t,r,a,n,l){e.push({x1:t,y1:r,x2:a,y2:n,z:l})}),complete({lines:C})},{async:!0}),e.asyncPlotter.run(g,e.TestData,e.Models,e.SelectedModel,e.Threshold).then(function(t){if(e.ClassifierProgress=1,null!=t.lines){var r=t.lines;!function(e,t){if(t.length>0)for(var r=0;r<t.length;r++)d(e,t[r].x1,t[r].y1,t[r].x2,t[r].y2,t[r].z)}(n,r)}},null,function(t){e.ClassifierProgress=t.ClassifierProgress}).catch(function(t){e.asyncPlotter=null})}}},e.SaveRenderedData=function(){var t=$("#plot")[0].innerHTML;if(null!=t){(t="<svg>"+t+"</svg>").match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(t=t.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),t.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(t=t.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="'+e.PlotWidth.toString()+'px" height="'+e.PlotHeight.toString()+'px"'));var n=new a([t],{type:"image/svg+xml;charset=utf-8"});r.saveAs(n,"Classification.svg")}}}]).directive("inputBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Items=0,e.Categories=0,e.Inputs=0,e.SelectedFile=t.target.files[0]})})}}).directive("testBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.Samples=0,e.TestFile=t.target.files[0]})})}}).directive("networkBind",function(){return function(e,t,r){t.bind("change",function(t){e.$apply(function(e){e[r.name]=t.target.files,e.NetworkFile=t.target.files[0]})})}});