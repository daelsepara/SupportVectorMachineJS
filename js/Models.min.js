class Matrix{static Create(t){var r=new Array(t||0),a=t;if(arguments.length>1)for(var i=Array.prototype.slice.call(arguments,1);a--;)r[t-1-a]=this.Create.apply(this,i);return r}static Clone(t){var r,a;if(Array.isArray(t)){for(a=t.slice(0),r=0;r<a.length;r++)a[r]=this.Clone(a[r]);return a}if("object"==typeof t)throw"Cannot clone array containing an object!";return t}static MemCopy(t,r,a,i,e){for(var h=0;h<e;h++)t[r+h]=a[i+h]}static Copy2D(t,r,a,i){if(i>=0&i<r.length)for(var e=0;e<t.length;e++)this.MemCopy(t[e],0,r[i+e],a,t[0].length)}static Copy2DOffset(t,r,a,i){if(i>=0&i<t.length&r.length>0)for(var e=0;e<r.length;e++)this.MemCopy(t[i+e],a,r[e],0,r[0].length)}static Transpose(t){var r,a,i,e=t.length,h=t[0].length;if(e>1&&h>1){for(r=this.Create(h,e),i=0;i<e;i++)for(a=0;a<h;a++)r[a][i]=t[i][a];return r}if(e>1&&1==h){for(r=this.Create(1,e),i=0;i<e;i++)r[i]=t[i][0];return[r]}if(h>1&&1==e){for(r=this.Create(h,1),a=0;a<h;a++)r[a][0]=t[0][a];return r}}static Multiply(t,r){var a=t[0].length,i=t.length,e=r[0].length;if(a==r.length){for(var h=this.Create(i,e),s=0;s<i;s++)for(var n=0;n<e;n++){h[s][n]=0;for(var l=0;l<a;l++)h[s][n]+=t[s][l]*r[l][n]}return h}}static Product(t,r){var a=t[0].length,i=t.length,e=r[0].length,h=r.length;if(a==e&&i==h){for(var s=this.Create(i,a),n=0;n<i;n++)for(var l=0;l<a;l++)s[n][l]=a>1?t[n][l]*r[n][l]:[t[n][l]*r[n][l]];return s}}static MultiplyVector(t,r){var a=t.length;if(a==r.length){for(var i=this.Create(a),e=0;e<a;e++)i[e]=t[e]*r[e];return i}}static MultiplyConstant(t,r=1){for(var a=t[0].length,i=t.length,e=this.Create(i,a),h=0;h<i;h++)for(var s=0;s<a;s++)e[h][s]=r*t[h][s];return e}static Add(t,r,a=1){var i=t[0].length,e=t.length,h=r[0].length,s=r.length;if(i==h&&e==s){for(var n=this.Create(e,i),l=0;l<e;l++)for(var o=0;o<i;o++)n[l][o]=t[l][o]+a*r[l][o];return n}}static AddConstant(t,r=0){for(var a=t[0].length,i=t.length,e=this.Create(i,a),h=0;h<i;h++)for(var s=0;s<a;s++)e[h][s]=t[h][s]+r;return e}static Sum(t){for(var r=t[0].length,a=t.length,i=0,e=0;e<a;e++)for(var h=0;h<r;h++)i+=t[e][h];return i}static SquareSum(t){for(var r=t[0].length,a=t.length,i=0,e=0;e<a;e++)for(var h=0;h<r;h++)i+=t[e][h]*t[e][h];return i}static Mean(t,r){var a,i,e,h;if(1===r){for(a=this.Create(t[0].length),i=0;i<t[0].length;i++){for(h=0,e=0;e<t.length;e++)h+=t[e][i];a[i]=h/t.length}return a}for(a=this.Create(t.length),e=0;e<t.length;e++){for(h=0,i=0;i<t[0].length;i++)h+=t[e][i];a[e]=h/t[0].length}return a}static Sigmoid(t){return 1/(1+Math.exp(-t))}static Diff(t,r){var a=t[0].length,i=t.length,e=r[0].length,h=r.length;if(a==e&&i==h){for(var s=this.Create(i,a),n=0;n<i;n++)for(var l=0;l<a;l++)s[n][l]=t[n][l]-r[n][l];return s}}static Sigm(t){for(var r=t[0].length,a=t.length,i=this.Create(a,r),e=0;e<a;e++)for(var h=0;h<r;h++)i[e][h]=this.Sigmoid(t[e][h]);return i}static DSigm(t){for(var r=t[0].length,a=t.length,i=this.Create(a,r),e=0;e<a;e++)for(var h=0;h<r;h++){var s=this.Sigmoid(t[e][h]);i[e][h]=s*(1-s)}return i}static CBind(t,r){var a=t[0].length,i=t.length,e=r[0].length;if(i==r.length){var h=a+e,s=i,n=this.Create(s,h);return this.Copy2DOffset(n,t,0,0),this.Copy2DOffset(n,r,a,0),n}}static Flip(t,r){for(var a=t.length,i=t[0].length,e=t[0][0].length,h=this.Create(a,i,e),s=0;s<a;s++)for(var n=0;n<i;n++)for(var l=0;l<e;l++)switch(r){case 0:h[s][n][l]=t[s][n][e-l-1];break;case 1:h[s][n][l]=t[s][i-n-1][l];break;case 2:h[s][n][l]=t[a-s-1][n][l];break;default:h[s][n][l]=t[s][n][e-l-1]}return h}static Flip2D(t,r){for(var a=t.length,i=t[0].length,e=this.Create(a,i),h=0;h<a;h++)for(var s=0;s<i;s++)switch(r){case 0:e[h][s]=t[h][i-s-1];break;case 1:e[h][s]=t[a-h-1][s];break;default:e[h][s]=t[h][i-s-1]}return e}static FlipAll(t){for(var r=t.length,a=t[0].length,i=t[0][0].length,e=this.Create(r,a,i),h=this.Clone(t),s=0;s<3;s++)e=this.Flip(h,s),h=this.Clone(e);return e}static Rotate180(t){for(var r=this.Create(t.length,t[0].length),a=this.Clone(t),i=0;i<2;i++)r=this.Flip2D(a,i),a=this.Clone(r);return r}static Expand(t,r,a){for(var i=t[0].length*r,e=t.length*a,h=this.Create(e,i),s=0;s<t.length;s++)for(var n=0;n<t[0].length;n++)for(var l=0;l<a;l++)for(var o=0;o<r;o++)h[s*a+l][n*r+o]=t[s][n];return h}static Vector(t){for(var r=this.Transpose(t),a=this.Create(t.length*t[0].length),i=0,e=0;e<r.length;e++)for(var h=0;h<r[0].length;h++)a[i]=r[e][h],i++;return a}static Column(t){for(var r=this.Create(t.length,1),a=0;a<t.length;a++)r[a][0]=t[a];return r}static RowSums(t){for(var r=this.Create(t.length,1),a=0;a<t.length;a++){r[a][0]=0;for(var i=0;i<t[0].length;i++)r[a][0]+=t[a][i]}return r}static ColSums(t){for(var r=this.Create(1,t[0].length),a=0;a<t[0].length;a++){r[0][a]=0;for(var i=0;i<t.length;i++)r[0][a]+=t[i][a]}return r}static Diag(t){if(t>0){for(var r=this.Create(t,t),a=0;a<t;a++)for(var i=0;i<t;i++)r[a][i]=i==a?1:0;return r}}static Sqrt(t){for(var r=t[0].length,a=t.length,i=this.Create(a,r),e=0;e<a;e++)for(var h=0;h<r;h++)i[e][h]=Math.sqrt(t[e][h]);return i}static Pow(t,r){for(var a=t[0].length,i=t.length,e=this.Create(i,a),h=0;h<i;h++)for(var s=0;s<a;s++)e[h][s]=Math.pow(t[h][s],r);return e}static Powers(t,r){for(var a=r[0].length,i=r.length,e=this.Create(i,a),h=0;h<i;h++)for(var s=0;s<a;s++)e[h][s]=Math.pow(t,r[h][s]);return e}static SetVector(t,r=0){for(var a=0;a<t.length;a++)t[a]=r}static Set(t,r=0){for(var a=t[0].length,i=t.length,e=0;e<i;e++)for(var h=0;h<a;h++)t[e][h]=r}static Normalize(t){var r,a,i=t[0].length,e=t.length,h=this.Create(e,i),s=this.Create(i),n=this.Create(i);for(r=0;r<i;r++)s[r]=Number.MIN_VALUE,n[r]=Number.MAX_VALUE;for(a=0;a<e;a++)for(r=0;r<i;r++)s[r]=Math.max(t[a][r],s[r]),n[r]=Math.min(t[a][r],n[r]);for(a=0;a<e;a++)for(r=0;r<i;r++){var l=s[r]-n[r];h[a][r]=(t[a][r]-n[r])/l}return{result:h,min:n,max:s}}static ApplyNormalization(t,r,a){for(var i=t[0].length,e=t.length,h=this.Create(e,i),s=0;s<e;s++)for(var n=0;n<i;n++){var l=r[n]-a[n];h[s][n]=(t[s][n]-a[n])/l}return h}}class KernelType{static get POLYNOMIAL(){return 0}static get GAUSSIAN(){return 1}static get RADIAL(){return 2}static get SIGMOID(){return 3}static get LINEAR(){return 4}static get FOURIER(){return 5}static get UNKNOWN(){return-1}}class KernelFunction{static Rows(t){return t.length}static Cols(t){return t[0].length}static Multiply(t,r){var a=Matrix.Vector(t),i=Matrix.Vector(r),e=0;if(a.length==i.length)for(var h=0;h<a.length;h++)e+=a[h]*i[h];return e}static SquaredDiff(t,r){var a=Matrix.Vector(t),i=Matrix.Vector(r),e=0;if(a.length==i.length)for(var h=0;h<a.length;h++){var s=a[h]-i[h];e+=s*s}return e}static Linear(t,r,a){return this.Multiply(t,r)*(a.length>0?a[0]:1)+(a.length>1?a[1]:0)}static Polynomial(t,r,a){var i=a.length>0?a[0]:0,e=a.length>1?a[1]:1;return Math.pow(this.Multiply(t,r)+i,e)}static Gaussian(t,r,a){var i=this.SquaredDiff(t,r),e=a.length>0?a[0]:1,h=2*e*e;return Math.abs(h)>0?Math.exp(-i/h):0}static Radial(t,r,a){var i=a.length>0?a[0]:1,e=2*i*i;return Math.abs(e)>0?Math.exp(-Math.sqrt(this.SquaredDiff(t,r))/e):0}static Sigmoid(t,r,a){var i=a.length>0?a[0]:1,e=a.length>1?a[1]:0;return Math.tanh(i*this.Multiply(t,r)/t.length+e)}static Fourier(t,r,a){for(var i=Matrix.Vector(t),e=Matrix.Vector(r),h=Matrix.Create(i.length),s=0,n=a.length>0?a[0]:1,l=0;l<i.length;l++){h[l]=2*Math.sin(n+.5);var o=i[l]-e[l];h[l]=Math.abs(o)>0?Math.sin(n+.5)*o/Math.sin(.5*o):h[l],s=0==l?h[l]:s*h[l]}return s}static Run(t,r,a,i){var e=0;return t==KernelType.LINEAR?e=this.Linear(r,a,i):t==KernelType.GAUSSIAN?e=this.Gaussian(r,a,i):t==KernelType.FOURIER?e=this.Fourier(r,a,i):t==KernelType.SIGMOID?e=this.Sigmoid(r,a,i):t==KernelType.RADIAL?e=this.Radial(r,a,i):t==KernelType.POLYNOMIAL&&(e=this.Polynomial(r,a,i)),e}}class SupportVectorMachine{constructor(){this.ModelX=void 0,this.ModelY=[],this.Type=KernelType.UNKNOWN,this.KernelParam=void 0,this.Alpha=void 0,this.W=void 0,this.B=0,this.C=0,this.Tolerance=0,this.Category=0,this.Iterations=0,this.MaxIterations=0,this.Trained=!1,this.K=[],this.E=[],this.alpha=[],this.dx=[],this.dy=[],this.b=0,this.eta=0,this.H=0,this.L=0}Initialize(t,r,a,i,e,h,s,n,l,o){this.ModelX=t,this.ModelY=r,this.Type=a,this.KernelParam=i,this.Alpha=e,this.B=h,this.W=s,this.MaxIterations=n,this.Trained=!0,this.C=l,this.Category=o}Rows(t){return t.length}Cols(t){return t[0].length}Setup(t,r,a,i,e,h=.001,s=5,n=1){this.dx=Matrix.Clone(t),this.dy=Matrix.Clone(r),this.Type=i;var l,o,M=this.Rows(this.dx);if(this.Category=n,this.MaxIterations=s,this.Tolerance=h,this.C=a,this.KernelParam=e,this.alpha=Matrix.Create(M),Matrix.SetVector(this.alpha,0),this.E=Matrix.Create(M),Matrix.SetVector(this.E,0),this.b=0,this.Iterations=0,i==KernelType.LINEAR){var p=Matrix.Transpose(this.dx);this.K=Matrix.Multiply(this.dx,p);var g=this.KernelParam.length>0?this.KernelParam[0]:1,f=this.KernelParam.length>1?this.KernelParam[1]:0;this.K=Matrix.MultiplyConstant(this.K,g),this.K=Matrix.AddConstant(this.K,f)}else if(i==KernelType.GAUSSIAN||i==KernelType.RADIAL){var x=Matrix.Pow(this.dx,2),u=Matrix.RowSums(x),v=Matrix.Transpose(u),C=Matrix.Transpose(this.dx),d=Matrix.Multiply(this.dx,C),c=Matrix.Expand(u,M,1),y=Matrix.Expand(v,1,M);d=Matrix.MultiplyConstant(d,-2),c=Matrix.Add(c,y),c=Matrix.Add(c,d);var K=this.KernelParam.length>0?this.KernelParam[0]:1,m=Math.abs(K)>0?Math.exp(-1/(2*K*K)):0;this.Type==KernelType.RADIAL&&(c=Matrix.Sqrt(c)),this.K=Matrix.Powers(m,c)}else{this.K=Matrix.Create(M,M);var A=Matrix.Create(1,this.Cols(this.dx)),T=Matrix.Create(1,this.Cols(this.dx));for(l=0;l<M;l++)for(Matrix.Copy2D(A,this.dx,0,l),o=0;o<M;o++)Matrix.Copy2D(T,this.dx,0,o),this.K[l][o]=KernelFunction.Run(i,A,T,this.KernelParam),this.K[o][l]=this.K[l][o]}for(this.eta=0,this.L=0,this.H=0,l=0;l<this.dy.length;l++)this.dy[l]=parseInt(this.dy[l])!=this.Category?-1:1}Step(){if(this.Iterations>=this.MaxIterations)return!0;var t,r,a=this.dy.length,i=0;for(t=0;t<a;t++){for(this.E[t]=this.b,r=0;r<a;r++)this.E[t]+=this.alpha[r]*this.dy[r]*this.K[t][r];if(this.E[t]-=this.dy[t],this.dy[t]*this.E[t]<-this.Tolerance&&this.alpha[t]<this.C||this.dy[t]*this.E[t]>this.Tolerance&&this.alpha[t]>0){for(var e=t;e==t;)e=parseInt(Math.floor(a*Math.random()));for(this.E[e]=this.b,r=0;r<a;r++)this.E[e]+=this.alpha[r]*this.dy[r]*this.K[e][r];this.E[e]-=this.dy[e];var h=this.alpha[t],s=this.alpha[e];if(parseInt(this.dy[t])==parseInt(this.dy[e])?(this.L=Math.max(0,this.alpha[e]+this.alpha[t]-this.C),this.H=Math.min(this.C,this.alpha[e]+this.alpha[t])):(this.L=Math.max(0,this.alpha[e]-this.alpha[t]),this.H=Math.min(this.C,this.C+this.alpha[e]-this.alpha[t])),Math.abs(this.L-this.H)<=Number.EPSILON)continue;if(this.eta=2*this.K[t][e]-this.K[t][t]-this.K[e][e],this.eta>=0)continue;if(this.alpha[e]=this.alpha[e]-this.dy[e]*(this.E[t]-this.E[e])/this.eta,this.alpha[e]=Math.min(this.H,this.alpha[e]),this.alpha[e]=Math.max(this.L,this.alpha[e]),Math.abs(this.alpha[e]-s)<this.Tolerance){this.alpha[e]=s;continue}this.alpha[t]=this.alpha[t]+this.dy[t]*this.dy[e]*(s-this.alpha[e]);var n=this.b-this.E[t]-this.dy[t]*(this.alpha[t]-h)*this.K[t][e]-this.dy[e]*(this.alpha[e]-s)*this.K[t][e],l=this.b-this.E[e]-this.dy[t]*(this.alpha[t]-h)*this.K[t][e]-this.dy[e]*(this.alpha[e]-s)*this.K[e][e];0<this.alpha[t]&&this.alpha[t]<this.C?this.b=n:0<this.alpha[e]&&this.alpha[e]<this.C?this.b=l:this.b=(n+l)/2,i++}}return 0==i?this.Iterations++:this.Iterations=0,this.Iterations>=this.MaxIterations}Generate(){var t,r,a=this.Rows(this.dx),i=this.Cols(this.dx),e=0;for(t=0;t<a;t++)Math.abs(this.alpha[t])>0&&e++;this.ModelX=Matrix.Create(e,this.Cols(this.dx)),this.ModelY=Matrix.Create(e),this.Alpha=Matrix.Create(e);var h=0;for(t=0;t<a;t++)if(Math.abs(this.alpha[t])>0){for(r=0;r<i;r++)this.ModelX[h][r]=this.dx[t][r];this.ModelY[h]=this.dy[t],this.Alpha[h]=this.alpha[t],h++}this.B=this.b;var s=[Matrix.MultiplyVector(this.alpha,this.dy)],n=Matrix.Multiply(s,this.dx);this.W=Matrix.Transpose(n),e>0&&(this.Trained=!0)}Train(t,r,a,i,e,h=.001,s=5,n=1){for(this.Setup(t,r,a,i,e,h,s,n);!this.Step(););this.Generate()}Predict(t){var r=Matrix.Create(this.Rows(t),1);if(this.Trained){var a=Matrix.Clone(t);1==this.Cols(t)?a=Matrix.Transpose(t):Matrix.Copy2D(a,t,0,0);var i=this.Rows(a);if(r=Matrix.Create(i,1),Matrix.Set(r,0),this.Type==KernelType.LINEAR)r=Matrix.Multiply(a,this.W),r=Matrix.AddConstant(r,this.B);else if(this.Type==KernelType.GAUSSIAN||this.Type==KernelType.RADIAL){var e=Matrix.Pow(a,2),h=Matrix.Pow(this.ModelX,2),s=Matrix.RowSums(h),n=Matrix.RowSums(e),l=Matrix.Transpose(s),o=Matrix.Transpose(this.ModelX),M=Matrix.Transpose(Matrix.Column(this.ModelY)),p=Matrix.Transpose(Matrix.Column(this.Alpha)),g=this.Rows(n),f=this.Cols(l),x=Matrix.Multiply(a,o);x=Matrix.MultiplyConstant(x,-2);var u=Matrix.Expand(n,f,1),v=Matrix.Expand(l,1,g);u=Matrix.Add(u,v),u=Matrix.Add(u,x);var C=this.KernelParam.length>0?this.KernelParam[0]:1;this.Type==KernelType.RADIAL&&(u=Matrix.Sqrt(u));var d=Math.abs(C)>0?Math.exp(-1/(2*C*C)):0,c=Matrix.Powers(d,u),y=Matrix.Expand(M,1,g),K=Matrix.Expand(p,1,g);c=Matrix.Product(c,y),c=Matrix.Product(c,K);var m=Matrix.RowSums(c);Matrix.Copy2D(r,m,0,0),r=Matrix.AddConstant(r,this.B)}else for(var A=Matrix.Create(1,this.Cols(a)),T=Matrix.Create(1,this.Cols(this.ModelX)),S=0;S<i;S++){var I=0;Matrix.Copy2D(A,a,0,S);for(var R=0;R<this.Rows(this.ModelX);R++)Matrix.Copy2D(T,this.ModelX,0,R),I+=this.Alpha[R]*this.ModelY[R]*KernelFunction.Run(this.Type,A,T,this.KernelParam);r[S][0]+=I+this.B}}return r}Classify(t,r=0){for(var a=Matrix.Create(this.Rows(t),1),i=this.Predict(t),e=0;e<i.length;e++)a[e][0]=i[e][0]>r?this.Category:0;return a}}